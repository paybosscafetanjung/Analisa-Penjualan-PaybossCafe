<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayBoss | Sales Insights (Super Manager Mode)</title>

  <!-- Chart.js + Tailwind -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      background: linear-gradient(135deg,#667eea 0%, #7c3aed 45%, #0ea5e9 100%);
      min-height: 100vh;
    }
    * { box-sizing: border-box; }

    .dashboard-container { max-width: 1280px; margin: 0 auto; padding: 20px; display: none; }

    /* Login */
    #auth-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 50; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.12); width: 92%; max-width: 420px; text-align: center; }
    .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 14px; outline: none; transition: border 0.2s; }
    .input-field:focus { border-color: #6366f1; }
    .btn-primary { width: 100%; padding: 12px; background: #4f46e5; color: white; border-radius: 12px; font-weight: 800; transition: background 0.2s; }
    .btn-primary:hover { background: #4338ca; }

    /* Cards */
    .card { background: rgba(255,255,255,0.96); padding: 18px; border-radius: 18px; box-shadow: 0 10px 18px rgba(15,23,42,0.08); border: 1px solid rgba(226,232,240,0.9); }
    .card h3 { color: #0f172a; font-size: 14px; font-weight: 900; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.2px; }
    .card h3::before { content: ''; display: inline-block; width: 4px; height: 16px; background: #6366f1; border-radius: 999px; }

    .kpi { background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.22); backdrop-filter: blur(10px); border-radius: 18px; padding: 16px; color: white; position: relative; overflow: hidden; }
    .kpi .label { font-size: 12px; opacity: 0.85; font-weight: 700; }
    .kpi .value { font-size: 22px; font-weight: 900; letter-spacing: -0.3px; margin-top: 4px; }
    .kpi .sub { font-size: 12px; opacity: 0.9; margin-top: 6px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }

    /* Growth Badge */
    .growth-badge { font-size: 11px; font-weight: 800; padding: 2px 6px; border-radius: 6px; display: inline-flex; align-items: center; gap: 2px; }
    .growth-up { background: #dcfce7; color: #15803d; }
    .growth-down { background: #fee2e2; color: #b91c1c; }
    .growth-neutral { background: #f1f5f9; color: #64748b; }

    .chart-box { height: 320px; position: relative; width: 100%; }

    .table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    .table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 900; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
    .table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #0f172a; }
    .table tr:hover td { background: #f8fafc; }
    .click-row { cursor: pointer; }

    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 900; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: #ef4444; color: white; padding: 14px 18px; border-radius: 12px; display: none; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.2); max-width: 420px; }
    .toast.show { display: block; animation: slideUp 0.2s ease; }
    @keyframes slideUp { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }

    /* Toggle chips */
    .chip { padding: 6px 10px; border-radius: 999px; font-weight: 900; font-size: 12px; border: 1px solid #e2e8f0; background: #fff; color: #0f172a; }
    .chip.active { background: #111827; color: #fff; border-color: #111827; }
    .chip.soft { background: #f1f5f9; }

    /* Drawer */
    #drawerOverlay { position: fixed; inset: 0; background: rgba(2,6,23,0.55); display: none; z-index: 60; }
    #drawer { position: fixed; top: 0; right: 0; height: 100vh; width: min(520px, 92vw); background: rgba(255,255,255,0.98);
      border-left: 1px solid #e2e8f0; box-shadow: -20px 0 40px rgba(0,0,0,0.18); transform: translateX(100%);
      transition: transform 0.25s ease; z-index: 70; display: flex; flex-direction: column;
    }
    #drawer.open { transform: translateX(0); }
  </style>
</head>

<body>

  <!-- AUTH SCREEN -->
  <div id="auth-overlay">
    <div class="login-box">
      <h2 class="text-2xl font-black text-slate-900 mb-1">Manager Access</h2>
      <p class="text-slate-500 text-sm mb-6">PayBoss ‚Ä¢ Super Manager Mode</p>
      <form onsubmit="handleLogin(event)">
        <input type="email" id="mgr-email" placeholder="Email" class="input-field" required>
        <input type="password" id="mgr-pass" placeholder="Password" class="input-field" required>
        <button type="submit" id="btn-login" class="btn-primary">Masuk</button>
      </form>
      <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
    </div>
  </div>

  <!-- DASHBOARD UI -->
  <div id="dashboard-ui" class="dashboard-container">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 text-white">
      <div>
        <h1 class="text-3xl font-black tracking-tight">üìä Sales Insights (Super Manager)</h1>
        <p class="text-white/85 text-sm mt-1">Fitur Lengkap: Matrix, Alert, Compare, Bundling & Drill-down.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="fetchData()" id="btn-refresh" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl font-extrabold text-sm shadow-lg transition flex items-center gap-2">
           üîÑ Refresh Data
        </button>
        <button onclick="downloadCSV()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl font-extrabold text-sm backdrop-blur-sm transition">üì• Export CSV</button>
        <button onclick="doLogout()" class="bg-red-500/80 hover:bg-red-600/80 text-white px-4 py-2 rounded-xl font-extrabold text-sm backdrop-blur-sm transition">Logout</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white/90 border border-white/60 backdrop-blur rounded-2xl p-3 shadow-sm mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold bg-indigo-100 text-indigo-700" onclick="setFilter('today')" id="btn-today">Hari Ini</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('week')" id="btn-week">7 Hari</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('month')" id="btn-month">30 Hari</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('custom')" id="btn-custom">Custom</button>

          <div class="ml-1 flex items-center gap-2">
            <span class="text-xs font-black text-slate-500">Chart:</span>
            <button id="mode-qty" class="chip active" onclick="setChartMode('qty')">Qty</button>
            <button id="mode-rev" class="chip" onclick="setChartMode('revenue')">Rev</button>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-2 md:items-center w-full md:w-auto">
          <!-- Category Filter SIMPLE (3 Kategori) -->
          <select id="filter-category" onchange="setCategory(this.value)" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 outline-none focus:border-indigo-500 bg-white">
            <option value="All">üìÅ Semua Kategori</option>
            <option value="Makanan">üçõ Makanan (All Food)</option>
            <option value="Minuman">ü•§ Minuman (All Drink)</option>
            <option value="Lain lain">üì¶ Lain lain</option>
          </select>

          <div class="flex gap-2">
            <input type="date" id="date-start" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700" />
            <input type="date" id="date-end" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700" />
          </div>
          <button onclick="applyCustomRange()" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-extrabold hover:bg-slate-800">Go</button>

          <div class="flex-1"></div>
          <input id="search-item" placeholder="Cari menu‚Ä¶" class="w-full md:w-40 px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold" />
        </div>
      </div>

      <div class="mt-3 flex justify-between items-center text-xs font-semibold text-slate-500">
         <span id="range-label">Range: Hari ini</span>
         <span id="data-status-label" class="text-indigo-600">Menunggu refresh...</span>
      </div>
    </div>

    <!-- KPI Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
      <div class="kpi">
        <div class="label">Total Revenue</div>
        <div class="value" id="kpi-revenue">Rp 0</div>
        <div class="sub">
          <span id="rev-growth" class="growth-badge growth-neutral">-</span>
          <span id="kpi-revenue-sub" class="text-xs">0% QRIS</span>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Total Orders</div>
        <div class="value" id="kpi-orders">0</div>
        <div class="sub">
          <span id="ord-growth" class="growth-badge growth-neutral">-</span>
          <span class="text-xs">transaksi valid</span>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Items Terjual</div>
        <div class="value" id="kpi-items">0</div>
        <div class="sub" id="kpi-items-sub">Qty total (Filter)</div>
      </div>

      <div class="kpi">
        <div class="label">AOV</div>
        <div class="value" id="kpi-aov">Rp 0</div>
        <div class="sub" id="kpi-aov-sub">Avg value per order</div>
      </div>

      <div class="kpi">
        <div class="label">Avg Items/Order</div>
        <div class="value" id="kpi-ipo">0</div>
        <div class="sub" id="kpi-ipo-sub">Rata-rata qty per transaksi</div>
      </div>
    </div>

    <!-- Trend: daily + hourly -->
    <div class="card mb-6">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
        <div>
          <h3>üìà Trend Harian + Jam Ramai</h3>
          <div class="text-xs text-slate-500 -mt-2">Analisa waktu sibuk untuk staffing & promo jam sepi.</div>
        </div>
        <div class="flex gap-2 items-center">
          <span class="text-xs font-black text-slate-500">View:</span>
          <button id="trend-view-rev" class="chip active" onclick="setTrendView('revenue')">Revenue</button>
          <button id="trend-view-ord" class="chip" onclick="setTrendView('orders')">Orders</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
        <div class="lg:col-span-2 p-3 rounded-2xl border bg-white">
          <div class="font-extrabold text-slate-900 text-sm mb-2">Trend Harian</div>
          <div style="height:280px;"><canvas id="dailyTrendChart"></canvas></div>
        </div>
        <div class="p-3 rounded-2xl border bg-white">
          <div class="font-extrabold text-slate-900 text-sm mb-2">Jam Ramai (Heatmap)</div>
          <div style="height:280px;"><canvas id="hourlyTrendChart"></canvas></div>
          <div id="staffingHint" class="text-xs text-slate-600 mt-2">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Menu Matrix -->
    <div class="card mb-6">
      <h3>üß© Menu Engineering Matrix (Profit vs Popularity)</h3>
      <div class="flex flex-col md:flex-row gap-4 h-full">
        <div class="flex-1 h-[340px] relative">
          <canvas id="matrixChart"></canvas>
        </div>
        <div class="md:w-64 flex flex-col justify-center space-y-4 text-xs">
          <div class="p-3 bg-green-50 rounded-lg border border-green-100">
            <div class="font-bold text-green-700 flex items-center"><span class="legend-dot" style="background:#22c55e"></span> STARS</div>
            <div class="text-green-600 mt-1">High Popularity, High Revenue. Pertahankan.</div>
          </div>
          <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-100">
            <div class="font-bold text-yellow-700 flex items-center"><span class="legend-dot" style="background:#eab308"></span> PLOWHORSES</div>
            <div class="text-yellow-600 mt-1">High Popularity, Low Revenue. Naikkan harga/efisiensi.</div>
          </div>
          <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
            <div class="font-bold text-blue-700 flex items-center"><span class="legend-dot" style="background:#60a5fa"></span> PUZZLES</div>
            <div class="text-blue-600 mt-1">Low Popularity, High Revenue. Butuh promosi.</div>
          </div>
          <div class="p-3 bg-red-50 rounded-lg border border-red-100">
            <div class="font-bold text-red-700 flex items-center"><span class="legend-dot" style="background:#ef4444"></span> DOGS</div>
            <div class="text-red-600 mt-1">Low Popularity, Low Revenue. Hapus/Bundling.</div>
          </div>
          <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
            <div class="font-extrabold text-slate-900">Tips</div>
            <div class="text-slate-600 mt-1">Klik menu di tabel untuk <span class="font-black">detail lengkap</span>.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">

      <!-- Top Sellers -->
      <div class="card lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <h3 class="mb-0">üî• Top Sellers (Click Row for Detail)</h3>
          <div class="flex gap-2 items-center">
            <span class="text-xs font-black text-slate-500">Chart:</span>
            <button id="top-toggle-qty" class="chip active" onclick="setChartMode('qty')">Qty</button>
            <button id="top-toggle-rev" class="chip" onclick="setChartMode('revenue')">Rev</button>
          </div>
        </div>

        <div class="chart-box mt-3"><canvas id="topChart"></canvas></div>

        <div class="mt-4 overflow-x-auto" style="max-height: 360px; overflow-y:auto; border-radius: 14px;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:54px;">#</th>
                <th>Menu</th>
                <th style="width:140px;">Kategori</th>
                <th style="width:90px;">Qty</th>
                <th style="width:140px;">Revenue</th>
                <th style="width:130px;">Attach Rate</th>
              </tr>
            </thead>
            <tbody id="topTbody">
              <tr><td colspan="6" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Insight Panel -->
      <div class="card">
        <h3>üß† Insight Strategis (Action Plan)</h3>
        <div class="space-y-3 text-sm text-slate-700" id="insightBox">
          <div class="text-slate-400">Menunggu data‚Ä¶</div>
        </div>
      </div>

      <!-- Bottom Sellers -->
      <div class="card lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <h3 class="mb-0">üê¢ Bottom Sellers (Evaluasi)</h3>
          <div class="flex gap-2 items-center">
            <span class="text-xs font-black text-slate-500">Chart:</span>
            <button id="bottom-toggle-qty" class="chip active" onclick="setChartMode('qty')">Qty</button>
            <button id="bottom-toggle-rev" class="chip" onclick="setChartMode('revenue')">Rev</button>
          </div>
        </div>

        <div class="chart-box mt-3"><canvas id="bottomChart"></canvas></div>

        <div class="mt-4 overflow-x-auto" style="max-height: 360px; overflow-y:auto; border-radius: 14px;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:54px;">#</th>
                <th>Menu</th>
                <th style="width:140px;">Kategori</th>
                <th style="width:90px;">Qty</th>
                <th style="width:140px;">Revenue</th>
                <th style="width:130px;">Saran</th>
              </tr>
            </thead>
            <tbody id="bottomTbody">
              <tr><td colspan="6" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Shift + Payment Split -->
      <div class="card">
        <h3>üí≥ Payment Split & Shift</h3>
        <div class="grid grid-cols-1 gap-3">
          <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-slate-900">Payment Split</div>
              <span class="pill bg-indigo-100 text-indigo-700" id="split-pill">0% QRIS</span>
            </div>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-slate-600 font-semibold">QRIS / Transfer</span><span class="font-extrabold" id="split-q">Rp 0</span></div>
              <div class="flex justify-between"><span class="text-slate-600 font-semibold">Cash</span><span class="font-extrabold" id="split-c">Rp 0</span></div>
              <div class="border-t pt-2 flex justify-between"><span class="text-slate-600 font-semibold">Total</span><span class="font-extrabold" id="split-t">Rp 0</span></div>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200 bg-white">
            <div class="font-extrabold text-slate-900 mb-2">Ringkasan Shift</div>
            <div class="text-xs text-slate-500 mb-3">00‚Äì08 (Pagi) ‚Ä¢ 08‚Äì16 (Siang) ‚Ä¢ 16‚Äì24 (Malam)</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Pagi</span><span class="font-extrabold" id="shift-pagi">Rp 0</span></div>
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Siang</span><span class="font-extrabold" id="shift-siang">Rp 0</span></div>
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Malam</span><span class="font-extrabold" id="shift-malam">Rp 0</span></div>
              <div class="border-t pt-2 flex justify-between"><span class="font-semibold text-slate-600">Total</span><span class="font-extrabold" id="shift-total">Rp 0</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- SUPER MANAGER MODE -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <!-- Alert Center -->
      <div class="card">
        <h3>üö® Alert Center</h3>
        <div class="text-xs text-slate-500 -mt-2 mb-3">Deteksi anomali (drop) & peluang.</div>
        <div id="alertList" class="space-y-2 text-sm">
          <div class="text-slate-400">Menunggu data‚Ä¶</div>
        </div>
      </div>

      <!-- Compare -->
      <div class="card lg:col-span-2">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="mb-0">üÜö Compare Menu</h3>
            <div class="text-xs text-slate-500">Bandingkan performa 2 menu (head-to-head).</div>
          </div>
          <div class="flex gap-2">
            <select id="cmpA" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 bg-white"></select>
            <select id="cmpB" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 bg-white"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3" id="cmpKpi">
          <div class="p-3 rounded-xl border bg-slate-50">
            <div class="text-[11px] font-bold text-slate-500">A Revenue</div>
            <div id="cmpAR" class="text-base font-black text-slate-900">Rp 0</div>
          </div>
          <div class="p-3 rounded-xl border bg-slate-50">
            <div class="text-[11px] font-bold text-slate-500">B Revenue</div>
            <div id="cmpBR" class="text-base font-black text-slate-900">Rp 0</div>
          </div>
          <div class="p-3 rounded-xl border bg-white">
            <div class="text-[11px] font-bold text-slate-500">A Attach</div>
            <div id="cmpAA" class="text-base font-black text-slate-900">0%</div>
          </div>
          <div class="p-3 rounded-xl border bg-white">
            <div class="text-[11px] font-bold text-slate-500">B Attach</div>
            <div id="cmpBA" class="text-base font-black text-slate-900">0%</div>
          </div>
        </div>

        <div class="mt-3 p-3 rounded-2xl border bg-white">
          <div class="font-extrabold text-slate-900 text-sm mb-2">Overlay Trend Harian</div>
          <div style="height:240px;"><canvas id="compareChart"></canvas></div>
          <div id="cmpNote" class="text-xs text-slate-500 mt-2">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Bundling Lab -->
    <div class="card mb-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="mb-0">üß™ Bundling Lab</h3>
          <div class="text-xs text-slate-500">Kombinasi menu terpopuler & simulator diskon.</div>
        </div>
        <div class="flex gap-2 items-center">
          <select id="bundlePair" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 bg-white"></select>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-3">
        <div class="lg:col-span-2 overflow-x-auto border rounded-2xl">
          <table class="table">
            <thead>
              <tr>
                <th style="width:54px;">#</th>
                <th>Pair</th>
                <th style="width:110px;">Support</th>
                <th style="width:110px;">Lift</th>
                <th style="width:140px;">Count</th>
                <th style="width:120px;">Action</th>
              </tr>
            </thead>
            <tbody id="comboTbody">
              <tr><td colspan="6" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="p-4 rounded-2xl border bg-slate-50">
          <div class="font-extrabold text-slate-900 mb-3">Quick Simulator</div>

          <div class="text-xs font-bold text-slate-500 mb-1">Discount item ke-2</div>
          <input id="simDiscount" type="range" min="0" max="40" value="10" class="w-full">
          <div class="text-sm font-extrabold text-slate-900 mt-1"><span id="simDiscountVal">10</span>%</div>

          <div class="text-xs font-bold text-slate-500 mb-1 mt-3">Target attach boost (pp)</div>
          <input id="simBoost" type="range" min="0" max="25" value="5" class="w-full">
          <div class="text-sm font-extrabold text-slate-900 mt-1">+<span id="simBoostVal">5</span> poin</div>

          <div class="border-t mt-4 pt-3 space-y-1 text-sm" id="simOutput">
            <div class="text-slate-400">Pilih pair untuk simulasi‚Ä¶</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Raw Transactions -->
    <div class="card">
      <h3>üßæ Transaksi (Ringkas)</h3>
      <div class="text-xs text-slate-500 mb-3">Menampilkan transaksi yang mengandung item sesuai filter.</div>
      <div class="overflow-x-auto" style="max-height: 320px; overflow-y:auto; border-radius: 14px;">
        <table class="table">
          <thead>
            <tr>
              <th style="width:140px;">Waktu</th>
              <th style="width:90px;">Shift</th>
              <th>Meja / Pelanggan</th>
              <th style="width:120px;">Metode</th>
              <th style="width:140px;" class="text-right">Total Order</th>
            </tr>
          </thead>
          <tbody id="txnTbody">
            <tr><td colspan="5" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Drawer -->
  <div id="drawerOverlay" onclick="closeDrawer()"></div>
  <div id="drawer">
    <div class="p-4 border-b flex items-start justify-between gap-3">
      <div>
        <div class="text-xs font-black text-slate-500">DRILL-DOWN MENU</div>
        <div id="drawerTitle" class="text-lg font-black text-slate-900">‚Äî</div>
        <div id="drawerSub" class="text-xs text-slate-600 mt-1">‚Äî</div>
      </div>
      <button onclick="closeDrawer()" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-extrabold hover:bg-slate-800">Tutup</button>
    </div>

    <div class="p-4 overflow-y-auto flex-1">
      <div class="grid grid-cols-2 gap-2">
        <div class="p-3 rounded-xl border bg-slate-50">
          <div class="text-[11px] font-bold text-slate-500">Qty</div>
          <div id="dQty" class="text-base font-black text-slate-900">0</div>
        </div>
        <div class="p-3 rounded-xl border bg-slate-50">
          <div class="text-[11px] font-bold text-slate-500">Revenue</div>
          <div id="dRev" class="text-base font-black text-slate-900">Rp 0</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="text-[11px] font-bold text-slate-500">Attach Rate</div>
          <div id="dAttach" class="text-base font-black text-slate-900">0%</div>
        </div>
        <div class="p-3 rounded-xl border bg-white">
          <div class="text-[11px] font-bold text-slate-500">Avg Price</div>
          <div id="dAvgPrice" class="text-base font-black text-slate-900">Rp 0</div>
        </div>
      </div>

      <div class="mt-4 p-3 rounded-2xl border bg-white">
        <div class="flex items-center justify-between">
          <div class="font-extrabold text-slate-900 text-sm">Trend Harian</div>
          <div class="flex gap-2">
            <button id="dViewRev" class="chip active" onclick="setDrawerView('revenue')">Rev</button>
            <button id="dViewQty" class="chip" onclick="setDrawerView('qty')">Qty</button>
            <button id="dViewAttach" class="chip" onclick="setDrawerView('attach')">Att</button>
          </div>
        </div>
        <div style="height:220px" class="mt-2"><canvas id="drawerDaily"></canvas></div>
      </div>

      <div class="mt-3 p-3 rounded-2xl border bg-white">
        <div class="font-extrabold text-slate-900 text-sm mb-2">Jam Ramai (Menu ini)</div>
        <div style="height:220px"><canvas id="drawerHourly"></canvas></div>
      </div>

      <div class="mt-3 p-3 rounded-2xl border bg-slate-50">
        <div class="font-extrabold text-slate-900 text-sm mb-2">Top Pairing (Kandidat Bundling)</div>
        <div id="drawerPairs" class="space-y-2 text-sm text-slate-700">
          <div class="text-slate-400">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Error</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== State =====
    let allOrders = [];
    let filteredOrders = [];
    let currentFilter = 'week';
    let currentCategory = 'All';
    let customRange = { start: null, end: null };
    let currentRange = { startBiz: null, endBiz: null }; // Track aktif range
    let chartMode = 'qty'; // qty | revenue
    let trendView = 'revenue'; // revenue | orders
    let drawerView = 'revenue'; // revenue | qty | attach
    let searchTimer = null;

    // ===== Charts Instances =====
    let topChart = null, bottomChart = null, matrixChart = null;
    let dailyTrendChart = null, hourlyTrendChart = null, compareChart = null;
    let drawerDailyChart = null, drawerHourlyChart = null;

    // ===== Helpers =====
    const DAY = 86400000;

    function showError(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4500);
    }

    function fmtRp(n) { return 'Rp ' + (Math.round(n || 0)).toLocaleString('id-ID'); }
    function pct(x) { return (isFinite(x) ? (x * 100).toFixed(1) : '0.0') + '%'; }
    function escapeHtml(str) { return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function fmtDay(ms) { return new Date(ms).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }); }

    function getBizDate(ts) {
      const d = new Date(ts);
      d.setHours(0,0,0,0);
      return d.getTime();
    }

    function normalizePayment(pm) {
      const s = String(pm || '').toLowerCase();
      if (s.includes('qris') || s.includes('transfer') || s.includes('ovo') || s.includes('gopay') || s.includes('dana')) return 'qris';
      return 'cash';
    }

    function getShiftLabel(ts) {
      const h = new Date(ts).getHours();
      if (h >= 0 && h < 8) return 'Pagi';
      if (h >= 8 && h < 16) return 'Siang';
      return 'Malam';
    }

    // ===== HEURISTIK KATEGORI SIMPLE (3 Kategori) =====
    const CATEGORY_RULES = [
      { key: 'Minuman', test: /(americano|latte|coffee|kopi|cappucino|magic|split|vietnam|banana|brown sugar|butterscotch|caramel|almond|hazelnut|espresso|vanilla|chocolate|cookies|matcha|red velvet|taro|mocktail|dark moon|flora|honey|kiwi|lembayung|midnight|ocean|peach|summer|tropical|lemon tea|tea)/i },
      { key: 'Makanan', test: /(kwetiau|mie|nasi|steak|spaghetti|bebek|bapao|burger|bola|chicken|cireng|empek|jamur|kentang|kulit|mix|pisang|roti|singkong|sotong|tahu|tempe|tofu|corn|gyoza|sosis|cheesecake|tiramisu|brownies|misu|mousse|donat|tom & jerry|sago|smoothie)/i },
      { key: 'Lain lain', test: /(telur|sauce|cleo|rokok|tissue|mineral|nasi putih$)/i }
    ];

    function inferCategory(item) {
      const name = String(item?.name || '');
      const lainRule = CATEGORY_RULES.find(r => r.key === 'Lain lain');
      if (lainRule.test.test(name)) return 'Lain lain';
      for (const r of CATEGORY_RULES) {
         if (r.key !== 'Lain lain' && r.test.test(name)) return r.key;
      }
      return 'Lain lain';
    }

    function safeItems(order) {
      const items = Array.isArray(order?.items) ? order.items : [];
      return items.map(i => ({
        name: String(i?.name || '-').trim(),
        qty: Number(i?.qty || 0) || 0,
        price: Number(i?.price || i?.unitPrice || 0) || 0,
        category: i?.category || i?.type || ''
      })).filter(i => i.name && i.qty > 0);
    }

    // Check Filter Kategori
    function isItemMatchCategory(cat) {
      if (currentCategory === 'All') return true;
      return String(cat || '') === currentCategory;
    }

    // Helper: Ekstrak Info Order yg Relevan
    function getRelevantOrderInfo(order) {
      const total = Number(order?.total || 0) || 0;
      const ts = Number(order?.timestamp || 0) || 0;
      if (!ts) return null;

      const allItems = safeItems(order);
      if (!allItems.length) return null;

      // Filter items sesuai kategori aktif
      const relevantItems = allItems.filter(i => isItemMatchCategory(inferCategory(i)));
      if (!relevantItems.length) return null;

      const allQty = allItems.reduce((a,i)=>a + (i.qty||0), 0);
      const relevantQty = relevantItems.reduce((a,i)=>a + (i.qty||0), 0);

      // Hitung Revenue prorata
      let relevantRevenue = 0;
      const sumPrice = relevantItems.reduce((acc, i) => acc + (i.price * i.qty), 0);
      if (sumPrice > 0) {
        relevantRevenue = sumPrice;
      } else {
        if (allQty > 0) relevantRevenue = total * (relevantQty / allQty);
      }

      return { ts, total, allItems, relevantItems, allQty, relevantQty, relevantRevenue };
    }

    function computeMetrics(orders) {
      let filteredOrderCount = 0;
      let totalRevenue = 0;
      let totalQty = 0;
      let payQ = 0, payC = 0;
      const shift = { Pagi: 0, Siang: 0, Malam: 0 };
      const itemAgg = new Map();

      orders.forEach(o => {
        const info = getRelevantOrderInfo(o);
        if (!info) return;

        filteredOrderCount++;
        totalRevenue += info.relevantRevenue;

        const p = normalizePayment(o?.paymentMethod);
        if (p === 'qris') payQ += info.relevantRevenue; else payC += info.relevantRevenue;
        shift[getShiftLabel(info.ts)] += info.relevantRevenue;

        // Agregasi item
        const unique = new Set();
        info.relevantItems.forEach(it => {
          let itemRev = 0;
          if (it.price > 0) itemRev = it.qty * it.price;
          else if (info.total > 0 && info.allQty > 0) itemRev = info.total * (it.qty / info.allQty);

          totalQty += it.qty;
          const cat = inferCategory(it);
          if (!itemAgg.has(it.name)) itemAgg.set(it.name, { name: it.name, qty: 0, revenue: 0, txCount: 0, category: cat });
          const row = itemAgg.get(it.name);
          row.qty += it.qty;
          row.revenue += itemRev;
          unique.add(it.name);
        });

        unique.forEach(name => {
          const row = itemAgg.get(name);
          if(row) row.txCount += 1;
        });
      });

      const items = Array.from(itemAgg.values()).map(r => ({
        ...r,
        attachRate: filteredOrderCount ? (r.txCount / filteredOrderCount) : 0,
        revShare: totalRevenue ? (r.revenue / totalRevenue) : 0,
        avgPrice: r.qty ? (r.revenue / r.qty) : 0,
      }));

      return {
        totalOrders: filteredOrderCount, totalRevenue, totalQty,
        aov: filteredOrderCount ? (totalRevenue / filteredOrderCount) : 0,
        itemsPerOrder: filteredOrderCount ? (totalQty / filteredOrderCount) : 0,
        payQ, payC, shift, items
      };
    }

    // ===== Time Series & Index Building =====
    function buildTimeSeries(orders, startBiz, endBiz) {
      const dayList = [];
      for (let t = startBiz; t <= endBiz; t += DAY) dayList.push(t);

      const byDayRev = new Map();
      const byDayOrd = new Map();
      const byHourRev = new Array(24).fill(0);
      const byHourOrd = new Array(24).fill(0);

      orders.forEach(o => {
        const info = getRelevantOrderInfo(o);
        if (!info) return;
        const day = getBizDate(info.ts);
        const h = new Date(info.ts).getHours();

        byDayRev.set(day, (byDayRev.get(day)||0) + info.relevantRevenue);
        byDayOrd.set(day, (byDayOrd.get(day)||0) + 1);
        byHourRev[h] += info.relevantRevenue;
        byHourOrd[h] += 1;
      });

      return {
        labels: dayList.map(fmtDay),
        dayRevenue: dayList.map(d => Math.round(byDayRev.get(d)||0)),
        dayOrders: dayList.map(d => (byDayOrd.get(d)||0)),
        hourLabels: Array.from({length:24}, (_,h)=> String(h).padStart(2,'0')+":00"),
        hourRevenue: byHourRev.map(x=>Math.round(x)),
        hourOrders: byHourOrd,
        startBiz, endBiz
      };
    }

    function buildManagerIndex(orders, startBiz, endBiz) {
      const totalOrdersByDay = new Map();
      const itemByDay = new Map(); 
      const itemByHour = new Map(); 
      const pairs = new Map();
      const dayList = [];
      for (let t = startBiz; t <= endBiz; t += DAY) dayList.push(t);

      function ensureItemDay(item, day) {
        if (!itemByDay.has(item)) itemByDay.set(item, new Map());
        const m = itemByDay.get(item);
        if (!m.has(day)) m.set(day, { qty: 0, rev: 0, itemOrders: 0 });
        return m.get(day);
      }
      function ensureItemHour(item) {
        if (!itemByHour.has(item)) itemByHour.set(item, new Array(24).fill(0));
        return itemByHour.get(item);
      }

      orders.forEach(o => {
        const info = getRelevantOrderInfo(o);
        if (!info) return;

        const day = getBizDate(info.ts);
        const hour = new Date(info.ts).getHours();
        totalOrdersByDay.set(day, (totalOrdersByDay.get(day)||0) + 1);

        const itemRevMap = new Map();
        const unique = new Set();

        info.relevantItems.forEach(it => {
          const name = it.name;
          unique.add(name);
          let itemRev = 0;
          if (it.price > 0) itemRev = it.qty * it.price;
          else if (info.total > 0 && info.allQty > 0) itemRev = info.total * (it.qty / info.allQty);
          
          itemRevMap.set(name, (itemRevMap.get(name)||0) + itemRev);
          
          const row = ensureItemDay(name, day);
          row.qty += it.qty;
          row.rev += itemRev;
          ensureItemHour(name)[hour] += itemRev;
        });

        unique.forEach(name => { ensureItemDay(name, day).itemOrders += 1; });

        // Bundling Logic (Pairing)
        const arr = Array.from(unique);
        for (let i=0; i<arr.length; i++) {
          for (let j=i+1; j<arr.length; j++) {
            const a = arr[i], b = arr[j];
            const x = a < b ? a : b;
            const y = a < b ? b : a;
            const key = `${x}|||${y}`;
            if (!pairs.has(key)) pairs.set(key, { a: x, b: y, count: 0, revA: 0, revB: 0 });
            const p = pairs.get(key);
            p.count += 1;
            p.revA += (itemRevMap.get(x)||0);
            p.revB += (itemRevMap.get(y)||0);
          }
        }
      });

      return { totalOrdersByDay, itemByDay, itemByHour, pairs, dayList };
    }

    // ===== Growth Logic =====
    function getPreviousRange(currentP, startC, endC) {
      if (currentP === 'today') return { start: startC-(7*DAY), end: endC-(7*DAY), label: 'vs Minggu Lalu' };
      if (currentP === 'week') return { start: startC-(7*DAY), end: startC-DAY, label: 'vs 7 Hari Lalu' };
      if (currentP === 'month') return { start: startC-(30*DAY), end: startC-DAY, label: 'vs 30 Hari Lalu' };
      const dur = endC - startC;
      return { start: startC-DAY-dur, end: startC-DAY, label: 'vs Periode Lalu' };
    }

    function renderGrowth(currM, startC, endC) {
      const { start, end, label } = getPreviousRange(currentFilter, startC, endC);
      const prevOrders = allOrders.filter(o => {
        if (!o?.timestamp) return false;
        const biz = getBizDate(o.timestamp);
        return biz >= start && biz <= end;
      });
      const prevM = computeMetrics(prevOrders);

      const renderBadge = (el, curr, prev) => {
        if(prev===0) {
          el.innerHTML = curr > 0 ? `‚ñ≤ 100% ${label}` : `- ${label}`;
          el.className = `growth-badge ${curr>0?'growth-up':'growth-neutral'}`;
        } else {
          const diff = curr - prev;
          const p = (diff / prev) * 100;
          const isUp = diff >= 0;
          el.innerHTML = `${isUp?'‚ñ≤':'‚ñº'} ${Math.abs(p).toFixed(0)}% ${label}`;
          el.className = `growth-badge ${isUp?'growth-up':'growth-down'}`;
        }
      };
      renderBadge(document.getElementById('rev-growth'), currM.totalRevenue, prevM.totalRevenue);
      renderBadge(document.getElementById('ord-growth'), currM.totalOrders, prevM.totalOrders);
    }

    // ===== Chart & UI Logic =====
    function setTrendViewUI(v) {
      document.getElementById('trend-view-rev').classList.toggle('active', v==='revenue');
      document.getElementById('trend-view-ord').classList.toggle('active', v==='orders');
    }

    function renderTrendCharts(series) {
      const dCtx = document.getElementById('dailyTrendChart');
      const hCtx = document.getElementById('hourlyTrendChart');
      if (!dCtx || !hCtx) return;

      if (dailyTrendChart) dailyTrendChart.destroy();
      const dailyData = trendView==='revenue' ? series.dayRevenue : series.dayOrders;
      dailyTrendChart = new Chart(dCtx, {
        type: 'line',
        data: {
          labels: series.labels,
          datasets: [{ label: trendView, data: dailyData, borderColor: '#111827', tension: 0.25 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
      });

      if (hourlyTrendChart) hourlyTrendChart.destroy();
      const hourData = trendView==='revenue' ? series.hourRevenue : series.hourOrders;
      hourlyTrendChart = new Chart(hCtx, {
        type: 'bar',
        data: {
          labels: series.hourLabels,
          datasets: [{ label: 'Hour', data: hourData, backgroundColor: '#4f46e5', borderRadius: 8 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
      });

      // Staffing Hint
      const arr = hourData.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v);
      const peak = arr[0] || {i:0,v:0};
      const peak2 = arr[1] || peak;
      const label = (i) => String(i).padStart(2,'0') + ":00";
      document.getElementById('staffingHint').innerHTML = `
        <span class="font-extrabold text-slate-900">Peak:</span> ${label(peak.i)} 
        ‚Ä¢ <span class="font-extrabold text-slate-900">Next:</span> ${label(peak2.i)}
        <div class="mt-1">Saran: Optimalkan staf di jam peak ini.</div>
      `;
    }

    // Chart Mode Toggle
    window.setChartMode = (mode) => {
      chartMode = mode;
      document.getElementById('mode-qty').classList.toggle('active', chartMode==='qty');
      document.getElementById('mode-rev').classList.toggle('active', chartMode==='revenue');
      document.getElementById('top-toggle-qty').classList.toggle('active', chartMode==='qty');
      document.getElementById('top-toggle-rev').classList.toggle('active', chartMode==='revenue');
      document.getElementById('bottom-toggle-qty').classList.toggle('active', chartMode==='qty');
      document.getElementById('bottom-toggle-rev').classList.toggle('active', chartMode==='revenue');
      
      const snap = window.__last_metrics;
      if (snap?.m) {
        const items = snap.m.items.filter(x => x.qty > 0);
        const top = [...items].sort((a,b)=>b.qty - a.qty || b.revenue - a.revenue).slice(0, 10);
        const bottom = [...items].sort((a,b)=>a.qty - b.qty || a.revenue - b.revenue).slice(0, 10);
        renderTopBottomCharts(top, bottom);
      }
    };

    window.setTrendView = (v) => {
      trendView = v;
      setTrendViewUI(v);
      if (window.__last_metrics?.series) renderTrendCharts(window.__last_metrics.series);
    };

    // Matrix Plugin
    Chart.register({
      id: 'quadrantLines',
      afterDraw(chart) {
        const { scales: { x, y }, ctx } = chart;
        const avgX = chart.$avgX, avgY = chart.$avgY;
        if (!x || !y || !Number.isFinite(avgX)) return;
        const xPix = x.getPixelForValue(avgX), yPix = y.getPixelForValue(avgY);
        ctx.save();
        ctx.lineWidth = 1; ctx.setLineDash([6, 6]); ctx.strokeStyle = 'rgba(15,23,42,0.35)';
        ctx.beginPath(); ctx.moveTo(xPix, y.top); ctx.lineTo(xPix, y.bottom); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x.left, yPix); ctx.lineTo(x.right, yPix); ctx.stroke();
        ctx.restore();
      }
    });

    function renderMatrix(items) {
      const ctx = document.getElementById('matrixChart');
      if (!ctx) return;
      if (matrixChart) matrixChart.destroy();

      const active = items.filter(x => x.qty > 0);
      if (!active.length) return;

      const avgQty = active.reduce((a,b)=>a+b.qty,0)/active.length;
      const avgRev = active.reduce((a,b)=>a+b.revenue,0)/active.length;

      const dataset = active.map(item => {
        let color = '#94a3b8';
        if (item.qty >= avgQty && item.revenue >= avgRev) color = '#22c55e';
        else if (item.qty >= avgQty) color = '#eab308';
        else if (item.revenue >= avgRev) color = '#60a5fa';
        else color = '#ef4444';
        return { x: item.qty, y: Math.round(item.revenue), name: item.name, color };
      });

      matrixChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [{ label: 'Matrix', data: dataset, backgroundColor: dataset.map(d=>d.color), pointRadius: 6 }] },
        options: {
          responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: { x: { title: {display:true, text:'Popularitas (Qty)'} }, y: { title: {display:true, text:'Profit (Rev)'} } }
        }
      });
      matrixChart.$avgX = avgQty; matrixChart.$avgY = avgRev; matrixChart.update();
    }

    function renderTopBottomCharts(top, bottom) {
      const topCtx = document.getElementById('topChart');
      const botCtx = document.getElementById('bottomChart');
      if (!topCtx || !botCtx) return;

      const getVal = (arr) => chartMode==='revenue' ? arr.map(x=>Math.round(x.revenue)) : arr.map(x=>x.qty);
      
      if (topChart) topChart.destroy();
      topChart = new Chart(topCtx, {
        type: 'bar',
        data: { labels: top.map(x=>x.name), datasets: [{ data: getVal(top), backgroundColor: '#4f46e5', borderRadius: 8 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
      });

      if (bottomChart) bottomChart.destroy();
      bottomChart = new Chart(botCtx, {
        type: 'bar',
        data: { labels: bottom.map(x=>x.name), datasets: [{ data: getVal(bottom), backgroundColor: '#ef4444', borderRadius: 8 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
      });
    }

    // ===== Alert & Super Manager =====
    function avg(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

    function getMenuSeriesFromIndex(menuName, idx) {
      const byDay = idx.itemByDay.get(menuName) || new Map();
      const qty = [], rev = [], attach = [];
      idx.dayList.forEach(day => {
        const r = byDay.get(day) || { qty: 0, rev: 0, itemOrders: 0 };
        const tot = idx.totalOrdersByDay.get(day) || 0;
        qty.push(Math.round(r.qty));
        rev.push(Math.round(r.rev));
        attach.push(tot ? (r.itemOrders / tot) : 0);
      });
      return { labels: idx.dayList.map(fmtDay), qty, rev, attach };
    }

    function renderAlertCenter(m, series, idx) {
      const el = document.getElementById('alertList');
      const alerts = [];
      if (series?.dayRevenue?.length >= 3) {
        const last = series.dayRevenue[series.dayRevenue.length - 1];
        const base = avg(series.dayRevenue.slice(0, -1));
        if (base > 0 && last < base * 0.70) alerts.push({ lvl: 'high', title: 'Revenue Drop', msg: `Hari terakhir ${fmtRp(last)} vs avg ${fmtRp(base)}.` });
      }
      
      if (!alerts.length) el.innerHTML = `<div class="p-3 bg-emerald-50 text-emerald-800 rounded-xl text-xs font-bold">Aman ‚úÖ Belum ada anomali signifikan.</div>`;
      else el.innerHTML = alerts.map(a => `<div class="p-3 bg-white border rounded-xl mb-2"><div class="font-bold text-slate-900">${a.title}</div><div class="text-xs text-slate-500">${a.msg}</div></div>`).join('');
    }

    function renderCompare(idx) {
      const A = document.getElementById('cmpA').value;
      const B = document.getElementById('cmpB').value;
      const ctx = document.getElementById('compareChart');
      if (!A || !B || !ctx) return;

      const sA = getMenuSeriesFromIndex(A, idx);
      const sB = getMenuSeriesFromIndex(B, idx);

      document.getElementById('cmpAR').textContent = fmtRp(sA.rev.reduce((a,b)=>a+b,0));
      document.getElementById('cmpBR').textContent = fmtRp(sB.rev.reduce((a,b)=>a+b,0));
      document.getElementById('cmpAA').textContent = pct(avg(sA.attach));
      document.getElementById('cmpBA').textContent = pct(avg(sB.attach));

      if (compareChart) compareChart.destroy();
      compareChart = new Chart(ctx, {
        type: 'line',
        data: { labels: sA.labels, datasets: [{ label: A, data: sA.rev, borderColor: '#4f46e5' }, { label: B, data: sB.rev, borderColor: '#0ea5e9' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { x: { display: false } } }
      });
    }

    function renderCombosTable(m, idx) {
      const tbody = document.getElementById('comboTbody');
      const rows = [...idx.pairs.values()].filter(p=>p.count>=2).sort((a,b)=>b.count-a.count).slice(0,10);
      if(!rows.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">Belum ada pairing.</td></tr>'; return; }
      
      tbody.innerHTML = rows.map((r,i) => `
        <tr>
          <td class="font-black text-slate-500">${i+1}</td>
          <td class="font-extrabold text-xs">${escapeHtml(r.a)} + ${escapeHtml(r.b)}</td>
          <td>${pct(r.count/m.totalOrders)}</td>
          <td>-</td>
          <td class="font-bold">${r.count}</td>
          <td><button class="px-2 py-1 bg-indigo-600 text-white rounded text-xs" onclick="usePairForSim('${escapeHtml(r.a)}|||${escapeHtml(r.b)}')">Use</button></td>
        </tr>
      `).join('');
    }

    window.usePairForSim = (key) => {
      const sel = document.getElementById('bundlePair');
      if (sel) sel.value = key;
      updateSim();
    };

    function updateSim() {
      const snap = window.__last_metrics;
      const key = document.getElementById('bundlePair').value;
      const p = snap?.index?.pairs.get(key);
      const out = document.getElementById('simOutput');
      if (!p) { out.innerHTML = '<div class="text-slate-400">Pilih pair...</div>'; return; }

      const discount = document.getElementById('simDiscount').value / 100;
      const boost = document.getElementById('simBoost').value / 100;
      const baseRev = p.revA + p.revB;
      const projected = (baseRev * (1-discount)) * (1+boost); // Simple logic
      
      out.innerHTML = `
        <div class="font-bold text-slate-900">${escapeHtml(p.a)} + ${escapeHtml(p.b)}</div>
        <div class="flex justify-between mt-2"><span>Base Rev:</span> <span class="font-bold">${fmtRp(baseRev)}</span></div>
        <div class="flex justify-between"><span>Proj. Rev:</span> <span class="font-bold text-indigo-600">${fmtRp(projected)}</span></div>
      `;
    }

    // ===== Drawer Logic =====
    window.closeDrawer = () => { document.getElementById('drawerOverlay').style.display='none'; document.getElementById('drawer').classList.remove('open'); };
    window.setDrawerView = (v) => {
      drawerView = v;
      document.getElementById('dViewRev').classList.toggle('active', v==='revenue');
      document.getElementById('dViewQty').classList.toggle('active', v==='qty');
      document.getElementById('dViewAttach').classList.toggle('active', v==='attach');
      const snap = window.__last_metrics;
      if (snap?.drawer?.menu) renderDrawerCharts(snap.drawer.menu, snap.index);
    };

    window.openMenuDrawer = (name) => {
      const snap = window.__last_metrics;
      const item = snap.m.items.find(x => x.name === name);
      if (!item) return;

      document.getElementById('drawerOverlay').style.display='block';
      document.getElementById('drawer').classList.add('open');
      document.getElementById('drawerTitle').textContent = name;
      document.getElementById('drawerSub').textContent = item.category;
      
      document.getElementById('dQty').textContent = item.qty;
      document.getElementById('dRev').textContent = fmtRp(item.revenue);
      document.getElementById('dAttach').textContent = pct(item.attachRate);
      document.getElementById('dAvgPrice').textContent = fmtRp(item.avgPrice);

      window.__last_metrics.drawer = { menu: name };
      renderDrawerCharts(name, snap.index);
      
      // Drawer Pairs
      const pRows = [...snap.index.pairs.values()].filter(p=>p.a===name||p.b===name).sort((a,b)=>b.count-a.count).slice(0,5);
      document.getElementById('drawerPairs').innerHTML = pRows.length ? pRows.map(r=> 
        `<div class="p-2 border rounded bg-white text-xs flex justify-between">
           <span class="font-bold">${escapeHtml(r.a===name?r.b:r.a)}</span>
           <span>${r.count} pair</span>
         </div>`
      ).join('') : '<div class="text-slate-400">No pairs.</div>';
    };

    function renderDrawerCharts(name, idx) {
      const s = getMenuSeriesFromIndex(name, idx);
      const ctx = document.getElementById('drawerDaily');
      if (drawerDailyChart) drawerDailyChart.destroy();
      const data = drawerView==='revenue'?s.rev : drawerView==='qty'?s.qty : s.attach.map(x=>x*100);
      drawerDailyChart = new Chart(ctx, {
        type: 'line',
        data: { labels: s.labels, datasets: [{ label: drawerView, data, borderColor: '#111827' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
      });

      const ctxH = document.getElementById('drawerHourly');
      if (drawerHourlyChart) drawerHourlyChart.destroy();
      const hData = idx.itemByHour.get(name) || [];
      drawerHourlyChart = new Chart(ctxH, {
        type: 'bar',
        data: { labels: Array.from({length:24},(_,i)=>i), datasets: [{ data: hData, backgroundColor: '#4f46e5' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
      });
    }

    // ===== UI Actions =====
    function renderTables(m) {
      const search = document.getElementById('search-item').value.toLowerCase();
      const items = m.items.filter(x=>x.qty>0 && (!search || x.name.toLowerCase().includes(search)));
      const top = [...items].sort((a,b)=>b.qty-a.qty).slice(0,10);
      const bot = [...items].sort((a,b)=>a.qty-b.qty).slice(0,10);

      document.getElementById('topTbody').innerHTML = top.map((x,i)=>`
        <tr class="click-row" onclick="openMenuDrawer('${escapeHtml(x.name)}')">
          <td class="font-black text-slate-500">${i+1}</td>
          <td class="font-bold text-slate-800">${escapeHtml(x.name)}</td>
          <td><span class="pill bg-slate-100 text-slate-600">${escapeHtml(x.category)}</span></td>
          <td class="font-bold">${x.qty}</td>
          <td class="font-bold">${fmtRp(x.revenue)}</td>
          <td><span class="pill bg-emerald-100 text-emerald-700">${pct(x.attachRate)}</span></td>
        </tr>`).join('');

      document.getElementById('bottomTbody').innerHTML = bot.map((x,i)=>`
        <tr class="click-row" onclick="openMenuDrawer('${escapeHtml(x.name)}')">
          <td class="font-black text-slate-500">${i+1}</td>
          <td class="font-bold text-slate-800">${escapeHtml(x.name)}</td>
          <td><span class="pill bg-slate-100 text-slate-600">${escapeHtml(x.category)}</span></td>
          <td class="font-bold">${x.qty}</td>
          <td class="font-bold">${fmtRp(x.revenue)}</td>
          <td><span class="pill bg-rose-100 text-rose-700">Evaluasi</span></td>
        </tr>`).join('');
    }

    function renderInsight(m) {
      const box = document.getElementById('insightBox');
      const items = m.items.filter(x => x.qty > 0);
      
      if (!items.length) {
        box.innerHTML = '<div class="text-slate-400">Belum ada data transaksi.</div>';
        return;
      }

      // Calculate Matrix Thresholds
      const avgQty = items.reduce((a,b)=>a+b.qty,0) / items.length;
      const avgRev = items.reduce((a,b)=>a+b.revenue,0) / items.length;

      // Identify Top & Bottom (by Qty for popularity context)
      const best = [...items].sort((a,b)=>b.qty - a.qty)[0];
      const worst = [...items].sort((a,b)=>a.qty - b.qty)[0];

      // Helper to determine quadrant
      const getQuad = (i) => {
        if (i.qty >= avgQty && i.revenue >= avgRev) return 'STAR';
        if (i.qty >= avgQty && i.revenue < avgRev) return 'PLOWHORSE';
        if (i.qty < avgQty && i.revenue >= avgRev) return 'PUZZLE';
        return 'DOG';
      };

      const strategies = {
        'STAR': { color: 'green', text: 'Menu Juara! üõ°Ô∏è Jaga stok & rasa, jangan diubah.' },
        'PLOWHORSE': { color: 'yellow', text: 'Populer tapi untung tipis. üí∏ Naikkan harga sedikit atau bundling.' },
        'PUZZLE': { color: 'blue', text: 'Untung besar tapi sepi. üì£ Butuh promo / rekomendasi kasir.' },
        'DOG': { color: 'red', text: 'Beban. ‚ö†Ô∏è Hapus, ganti resep, atau bundling paksa.' }
      };

      const bestQuad = getQuad(best);
      const worstQuad = getQuad(worst);
      const bestStrat = strategies[bestQuad];
      const worstStrat = strategies[worstQuad];

      // Operational stats
      const qPct = m.totalRevenue ? (m.payQ / m.totalRevenue) : 0;
      const peakShift = Object.entries(m.shift).sort((a,b)=>b[1]-a[1])[0];

      box.innerHTML = `
        <div class="space-y-3">
          <!-- Card 1: Top Menu Analysis -->
          <div class="p-3 bg-${bestStrat.color}-50 border border-${bestStrat.color}-200 rounded-xl relative overflow-hidden">
             <div class="text-xs font-bold text-${bestStrat.color}-800 uppercase tracking-wider mb-1">Menu Paling Laku</div>
             <div class="text-lg font-black text-slate-900 mb-1">${escapeHtml(best.name)}</div>
             <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 rounded text-[10px] font-black bg-white border border-${bestStrat.color}-300 text-${bestStrat.color}-700">${bestQuad}</span>
                <span class="text-xs text-slate-600">${best.qty} Terjual ‚Ä¢ ${fmtRp(best.revenue)}</span>
             </div>
             <div class="text-xs text-slate-700 bg-white/60 p-2 rounded-lg border border-${bestStrat.color}-100 leading-relaxed">
               üí° <strong>Saran:</strong> ${bestStrat.text}
             </div>
          </div>

          <!-- Card 2: Low Menu Analysis -->
          <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Perlu Perhatian (Bottom)</div>
             <div class="text-sm font-bold text-slate-900">${escapeHtml(worst.name)}</div>
             <div class="text-xs text-slate-500 mb-2">Status: <strong>${worstQuad}</strong></div>
             <div class="text-xs text-slate-600 leading-relaxed">
               üëâ ${worstStrat.text}
             </div>
          </div>

          <!-- Card 3: Quick Ops -->
          <div class="grid grid-cols-2 gap-2">
             <div class="p-2 bg-white border rounded-xl text-center">
                <div class="text-[10px] text-slate-500 font-bold">JAM RAMAI</div>
                <div class="text-sm font-black text-indigo-600">${peakShift[0]}</div>
             </div>
             <div class="p-2 bg-white border rounded-xl text-center">
                <div class="text-[10px] text-slate-500 font-bold">PEMBAYARAN</div>
                <div class="text-sm font-black text-indigo-600">${pct(qPct)} QRIS</div>
             </div>
          </div>
        </div>
      `;
    }

    function renderTransactions(orders) {
      const tbody = document.getElementById('txnTbody');
      const active = orders.filter(o => getRelevantOrderInfo(o)).sort((a,b)=>b.timestamp-a.timestamp).slice(0,100);
      tbody.innerHTML = active.length ? active.map(o => `
        <tr>
          <td class="text-xs text-slate-500 font-mono">${new Date(o.timestamp).toLocaleString('id-ID')}</td>
          <td><span class="pill bg-slate-100 text-slate-600">${getShiftLabel(o.timestamp)}</span></td>
          <td class="font-bold text-slate-800">${escapeHtml(o.table||'-')}</td>
          <td><span class="pill ${normalizePayment(o.paymentMethod)==='qris'?'bg-indigo-100 text-indigo-700':'bg-slate-100 text-slate-700'}">${normalizePayment(o.paymentMethod).toUpperCase()}</span></td>
          <td class="text-right font-bold">${fmtRp(o.total)}</td>
        </tr>`).join('') : '<tr><td colspan="5" class="text-center py-8 text-slate-400">Empty.</td></tr>';
    }

    // ===== MISSING FUNCTION RESTORED =====
    function renderKPIs(m) {
      document.getElementById('kpi-revenue').textContent = fmtRp(m.totalRevenue);
      document.getElementById('kpi-orders').textContent = (m.totalOrders || 0).toLocaleString('id-ID');
      document.getElementById('kpi-items').textContent = (m.totalQty || 0).toLocaleString('id-ID');
      document.getElementById('kpi-aov').textContent = fmtRp(m.aov);
      document.getElementById('kpi-ipo').textContent = (m.itemsPerOrder || 0).toFixed(2);

      const qPct = m.totalRevenue ? (m.payQ / m.totalRevenue) : 0;
      const cPct = m.totalRevenue ? (m.payC / m.totalRevenue) : 0;
      document.getElementById('kpi-revenue-sub').textContent = `${pct(qPct)} QRIS ‚Ä¢ ${pct(cPct)} Cash`;

      document.getElementById('split-q').textContent = fmtRp(m.payQ);
      document.getElementById('split-c').textContent = fmtRp(m.payC);
      document.getElementById('split-t').textContent = fmtRp(m.totalRevenue);
      document.getElementById('split-pill').textContent = `${pct(qPct)} QRIS`;

      document.getElementById('shift-pagi').textContent = fmtRp(m.shift.Pagi);
      document.getElementById('shift-siang').textContent = fmtRp(m.shift.Siang);
      document.getElementById('shift-malam').textContent = fmtRp(m.shift.Malam);
      document.getElementById('shift-total').textContent = fmtRp(m.totalRevenue);
    }

    function recomputeAndRender() {
      const m = computeMetrics(filteredOrders);
      renderKPIs(m);
      if(currentRange.startBiz && currentRange.endBiz) renderGrowth(m, currentRange.startBiz, currentRange.endBiz);
      
      const series = buildTimeSeries(filteredOrders, currentRange.startBiz, currentRange.endBiz);
      renderTrendCharts(series);
      
      const idx = buildManagerIndex(filteredOrders, currentRange.startBiz, currentRange.endBiz);
      
      renderTables(m);
      renderMatrix(m.items);
      renderInsight(m); // Now uses the enhanced logic
      renderTransactions(filteredOrders);
      
      renderAlertCenter(m, series, idx);
      renderCombosTable(m, idx);
      
      // Populate compare options
      const names = m.items.sort((a,b)=>b.revenue-a.revenue).map(x=>x.name);
      const mkOpt = (sel) => sel.innerHTML = names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      if(!document.getElementById('cmpA').value) { mkOpt(document.getElementById('cmpA')); mkOpt(document.getElementById('cmpB')); }
      renderCompare(idx);

      // Populate bundle options
      const pairs = [...idx.pairs.values()].sort((a,b)=>b.count-a.count).slice(0,50);
      document.getElementById('bundlePair').innerHTML = pairs.map(p=>`<option value="${p.a}|||${p.b}">${p.a} + ${p.b}</option>`).join('');
      updateSim();

      window.__last_metrics = { m, series, index: idx };
    }

    // ===== Main Data Fetch =====
    window.fetchData = async () => {
      const btn = document.getElementById('btn-refresh');
      const st = document.getElementById('data-status-label');
      btn.innerHTML = '‚è≥ Loading...'; btn.disabled = true; st.textContent = 'Mengambil data...';

      try {
        const q = query(collection(db, 'completedOrders'), limit(2500));
        const snap = await getDocs(q);
        allOrders = snap.docs.map(d => {
          const dt = d.data();
          return { ...dt, timestamp: dt.createdAt?.seconds*1000 || dt.timestamp || Date.now() };
        }).filter(o => o.timestamp && (Number(o.total||0)>=0)).sort((a,b)=>a.timestamp-b.timestamp);

        const now = new Date();
        const fmt = (d) => d.toISOString().split('T')[0];
        document.getElementById('date-start').value = fmt(now);
        document.getElementById('date-end').value = fmt(now);

        // Reset Filter UI
        document.querySelectorAll('.filter-btn').forEach(b=> { b.classList.remove('bg-indigo-100','text-indigo-700'); b.classList.add('text-slate-600'); });
        document.getElementById('btn-week').classList.add('bg-indigo-100','text-indigo-700');
        
        filterOrders('week');
        st.textContent = `Updated: ${new Date().toLocaleTimeString()} (${allOrders.length} data)`;
        st.className = 'text-green-600 font-bold';
      } catch (e) {
        console.error(e); showError('Gagal ambil data.');
        st.textContent = 'Error update.'; st.className = 'text-red-500';
      } finally {
        btn.innerHTML = 'üîÑ Refresh Data'; btn.disabled = false;
      }
    };

    // Filter Wrappers
    window.setFilter = (f) => {
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b=> { b.classList.remove('bg-indigo-100','text-indigo-700'); b.classList.add('text-slate-600'); });
      const btn = document.getElementById('btn-'+f);
      if(btn) { btn.classList.remove('text-slate-600'); btn.classList.add('bg-indigo-100','text-indigo-700'); }
      filterOrders(f);
    };
    window.setCategory = (c) => { currentCategory = c; filterOrders(currentFilter); };
    window.applyCustomRange = () => {
      const s = document.getElementById('date-start').value;
      const e = document.getElementById('date-end').value;
      if(!s||!e) return alert('Pilih tanggal.');
      customRange = { start: getBizDate(new Date(s).getTime()), end: getBizDate(new Date(e).getTime()) };
      setFilter('custom');
    };
    function filterOrders(p) {
      const now = new Date(), today = getBizDate(now.getTime());
      let s, e;
      if (p==='today') { s=today; e=today; }
      else if (p==='week') { s=today-(6*DAY); e=today; }
      else if (p==='month') { s=today-(29*DAY); e=today; }
      else { s=customRange.start; e=customRange.end; }
      
      currentRange = { startBiz: s, endBiz: e };
      document.getElementById('range-label').textContent = `Range: ${fmtDay(s)} - ${fmtDay(e)}`;
      
      filteredOrders = allOrders.filter(o => {
        const b = getBizDate(o.timestamp);
        return b >= s && b <= e;
      });
      recomputeAndRender();
    }

    // Input Listeners
    document.getElementById('search-item').addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => renderTables(window.__last_metrics.m), 300);
    });
    document.getElementById('simDiscount').addEventListener('input', (e) => {
      document.getElementById('simDiscountVal').textContent = e.target.value; updateSim();
    });
    document.getElementById('simBoost').addEventListener('input', (e) => {
      document.getElementById('simBoostVal').textContent = e.target.value; updateSim();
    });
    document.getElementById('cmpA').addEventListener('change', () => renderCompare(window.__last_metrics.index));
    document.getElementById('cmpB').addEventListener('change', () => renderCompare(window.__last_metrics.index));
    document.getElementById('bundlePair').addEventListener('change', updateSim);

    // Auth & Boot
    window.handleLogin = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('btn-login');
      btn.textContent = 'Loading...'; btn.disabled = true;
      try {
        await signInWithEmailAndPassword(auth, document.getElementById('mgr-email').value, document.getElementById('mgr-pass').value);
      } catch (err) {
        document.getElementById('login-error').textContent = 'Gagal: ' + err.message;
        document.getElementById('login-error').classList.remove('hidden');
        btn.textContent = 'Masuk'; btn.disabled = false;
      }
    };
    window.doLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('dashboard-ui').style.display = 'block';
        fetchData();
      } else {
        document.getElementById('auth-overlay').style.display = 'flex';
        document.getElementById('dashboard-ui').style.display = 'none';
      }
    });
  </script>
</body>
</html>
