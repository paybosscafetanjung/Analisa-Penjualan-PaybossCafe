<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayBoss | Simple Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background: linear-gradient(135deg,#667eea 0%, #7c3aed 45%, #0ea5e9 100%); min-height: 100vh; }
    * { box-sizing: border-box; }

    .dashboard-container { max-width: 1280px; margin: 0 auto; padding: 20px; display: none; }

    /* Login */
    #auth-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 50; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.12); width: 92%; max-width: 420px; text-align: center; }
    .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 14px; outline: none; transition: border 0.2s; }
    .input-field:focus { border-color: #6366f1; }
    .btn-primary { width: 100%; padding: 12px; background: #4f46e5; color: white; border-radius: 12px; font-weight: 800; transition: background 0.2s; }
    .btn-primary:hover { background: #4338ca; }

    /* Cards */
    .card { background: rgba(255,255,255,0.96); padding: 18px; border-radius: 18px; box-shadow: 0 10px 18px rgba(15,23,42,0.08); border: 1px solid rgba(226,232,240,0.9); }
    .card h3 { color: #0f172a; font-size: 14px; font-weight: 900; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.2px; }
    .card h3::before { content: ''; display: inline-block; width: 4px; height: 16px; background: #6366f1; border-radius: 999px; }

    .kpi { background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.22); backdrop-filter: blur(10px); border-radius: 18px; padding: 16px; color: white; position: relative; overflow: hidden; }
    .kpi .label { font-size: 12px; opacity: 0.85; font-weight: 700; }
    .kpi .value { font-size: 22px; font-weight: 900; letter-spacing: -0.3px; margin-top: 4px; }
    .kpi .sub { font-size: 12px; opacity: 0.9; margin-top: 6px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    
    /* Growth Badge */
    .growth-badge { font-size: 11px; font-weight: 800; padding: 2px 6px; border-radius: 6px; display: inline-flex; align-items: center; gap: 2px; }
    .growth-up { background: #dcfce7; color: #15803d; } /* Green */
    .growth-down { background: #fee2e2; color: #b91c1c; } /* Red */
    .growth-neutral { background: #f1f5f9; color: #64748b; } /* Gray */

    /* Chart Box adjusted for bottom labels */
    .chart-box { height: 320px; position: relative; width: 100%; }

    .table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    .table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 900; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
    .table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #0f172a; }
    .table tr:hover td { background: #f8fafc; }

    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 900; }

    /* Matrix Badges */
    .mx-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .mx-stars { background: #dcfce7; color: #15803d; }
    .mx-plow { background: #fef9c3; color: #854d0e; }
    .mx-puzzle { background: #dbeafe; color: #1e40af; }
    .mx-dogs { background: #fee2e2; color: #991b1b; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: #ef4444; color: white; padding: 14px 18px; border-radius: 12px; display: none; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.2); max-width: 420px; }
    .toast.show { display: block; animation: slideUp 0.2s ease; }
    @keyframes slideUp { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Legend Dot */
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
  </style>
</head>
<body>

  <!-- AUTH SCREEN -->
  <div id="auth-overlay">
    <div class="login-box">
      <h2 class="text-2xl font-black text-slate-900 mb-1">Manager Access</h2>
      <p class="text-slate-500 text-sm mb-6">PayBoss ‚Ä¢ Sales Insights Dashboard</p>
      <form onsubmit="handleLogin(event)">
        <input type="email" id="mgr-email" placeholder="Email" class="input-field" required>
        <input type="password" id="mgr-pass" placeholder="Password" class="input-field" required>
        <button type="submit" id="btn-login" class="btn-primary">Masuk</button>
      </form>
      <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
    </div>
  </div>

  <!-- DASHBOARD UI -->
  <div id="dashboard-ui" class="dashboard-container">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 text-white">
      <div>
        <h1 class="text-3xl font-black tracking-tight">üìä Sales Insights (Ringkas)</h1>
        <p class="text-white/85 text-sm mt-1">Mode Hemat Data: Refresh manual untuk update.</p>
      </div>
      <div class="flex gap-2">
        <button onclick="fetchData()" id="btn-refresh" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl font-extrabold text-sm shadow-lg transition flex items-center gap-2">
           üîÑ Refresh Data
        </button>
        <button onclick="downloadCSV()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl font-extrabold text-sm backdrop-blur-sm transition">üì• Export CSV</button>
        <button onclick="doLogout()" class="bg-red-500/80 hover:bg-red-600/80 text-white px-4 py-2 rounded-xl font-extrabold text-sm backdrop-blur-sm transition">Logout</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white/90 border border-white/60 backdrop-blur rounded-2xl p-3 shadow-sm mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold bg-indigo-100 text-indigo-700" onclick="setFilter('today')" id="btn-today">Hari Ini</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('week')" id="btn-week">7 Hari</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('month')" id="btn-month">30 Hari</button>
          <button class="filter-btn px-4 py-2 rounded-xl text-sm font-extrabold text-slate-600 hover:bg-slate-100" onclick="setFilter('custom')" id="btn-custom">Custom</button>
        </div>

        <div class="flex flex-col md:flex-row gap-2 md:items-center w-full md:w-auto">
          
          <!-- Category Filter SIMPLE -->
          <select id="filter-category" onchange="setCategory(this.value)" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700 outline-none focus:border-indigo-500 bg-white">
            <option value="All">üìÅ Semua Kategori</option>
            <option value="Makanan">üçõ Makanan (Food/Snack/Pastry)</option>
            <option value="Minuman">ü•§ Minuman (Coffee/Non/Tea)</option>
            <option value="Lain lain">üì¶ Lain lain</option>
          </select>

          <div class="flex gap-2">
            <input type="date" id="date-start" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700" />
            <input type="date" id="date-end" class="px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-700" />
          </div>
          <button onclick="applyCustomRange()" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-extrabold hover:bg-slate-800">Terapkan</button>
          <div class="flex-1"></div>
          <input id="search-item" oninput="renderTables()" placeholder="Cari nama menu‚Ä¶" class="w-full md:w-48 px-3 py-2 rounded-xl border border-slate-200 text-sm font-bold" />
        </div>
      </div>

      <div class="mt-3 flex justify-between items-center text-xs font-semibold text-slate-500">
         <span id="range-label">Range: Hari ini</span>
         <span id="data-status-label" class="text-indigo-600">Menunggu refresh...</span>
      </div>
    </div>

    <!-- KPI Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
      <!-- REVENUE with Growth -->
      <div class="kpi">
        <div class="label">Total Revenue</div>
        <div class="value" id="kpi-revenue">Rp 0</div>
        <div class="sub">
           <span id="rev-growth" class="growth-badge growth-neutral">-</span>
           <span id="kpi-revenue-sub" class="text-xs">0% QRIS</span>
        </div>
      </div>

      <!-- ORDERS with Growth -->
      <div class="kpi">
        <div class="label">Total Orders</div>
        <div class="value" id="kpi-orders">0</div>
        <div class="sub">
            <span id="ord-growth" class="growth-badge growth-neutral">-</span>
            <span class="text-xs">transaksi valid</span>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Items Terjual</div>
        <div class="value" id="kpi-items">0</div>
        <div class="sub" id="kpi-items-sub">Qty total (Filter)</div>
      </div>
      <div class="kpi">
        <div class="label">AOV</div>
        <div class="value" id="kpi-aov">Rp 0</div>
        <div class="sub" id="kpi-aov-sub">Avg value per order</div>
      </div>
      <div class="kpi">
        <div class="label">Avg Items/Order</div>
        <div class="value" id="kpi-ipo">0</div>
        <div class="sub" id="kpi-ipo-sub">Rata-rata qty per transaksi</div>
      </div>
    </div>

    <!-- Menu Matrix (Scatter Plot) -->
    <div class="card mb-6">
      <h3>üß© Menu Engineering Matrix (Profit vs Popularity)</h3>
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="flex-1 h-[340px] relative">
           <canvas id="matrixChart"></canvas>
        </div>
        <div class="md:w-64 flex flex-col justify-center space-y-4 text-xs">
           <div class="p-3 bg-green-50 rounded-lg border border-green-100">
             <div class="font-bold text-green-700 flex items-center"><span class="legend-dot bg-green-500"></span> STARS</div>
             <div class="text-green-600 mt-1">High Popularity, High Revenue.</div>
           </div>
           <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-100">
             <div class="font-bold text-yellow-700 flex items-center"><span class="legend-dot bg-yellow-400"></span> PLOWHORSES</div>
             <div class="text-yellow-600 mt-1">High Popularity, Low Revenue.</div>
           </div>
           <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
             <div class="font-bold text-blue-700 flex items-center"><span class="legend-dot bg-blue-400"></span> PUZZLES</div>
             <div class="text-blue-600 mt-1">Low Popularity, High Revenue.</div>
           </div>
           <div class="p-3 bg-red-50 rounded-lg border border-red-100">
             <div class="font-bold text-red-700 flex items-center"><span class="legend-dot bg-red-500"></span> DOGS</div>
             <div class="text-red-600 mt-1">Low Popularity, Low Revenue.</div>
           </div>
        </div>
      </div>
      <!-- Matrix Insight & Action Box -->
      <div id="matrix-insight" class="bg-slate-50 rounded-xl p-5 border border-slate-200">
          <div class="text-center text-slate-400 text-sm">Menghitung matriks...</div>
      </div>
    </div>

    <!-- NEW: MATRIX DETAIL TABLE -->
    <div class="card mb-6">
      <h3>üìã Detail Matrix Menu (Urut Status)</h3>
      <div class="overflow-x-auto" style="max-height: 400px; overflow-y:auto; border-radius: 14px;">
        <table class="table">
          <thead>
            <tr>
              <th>Menu</th>
              <th>Kategori</th>
              <th style="width:100px;">Qty</th>
              <th style="width:140px;">Revenue</th>
              <th style="width:120px;">Status</th>
            </tr>
          </thead>
          <tbody id="matrixTableBody">
            <tr><td colspan="5" class="text-center py-8 text-slate-400">Menunggu data matriks...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">

      <!-- Top Sellers -->
      <div class="card lg:col-span-2">
        <h3>üî• Top Sellers (Qty & Revenue)</h3>
        <div id="top-summary" class="mb-3 text-xs font-bold text-indigo-700 bg-indigo-50 px-3 py-2 rounded-lg">Loading Summary...</div>
        <div class="chart-box"><canvas id="topChart"></canvas></div>
        <div class="mt-4 overflow-x-auto" style="max-height: 360px; overflow-y:auto; border-radius: 14px;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:54px;">#</th>
                <th>Menu</th>
                <th style="width:140px;">Kategori</th>
                <th style="width:90px;">Qty</th>
                <th style="width:140px;">Revenue</th>
                <th style="width:100px;">Kontribusi</th>
              </tr>
            </thead>
            <tbody id="topTbody">
              <tr><td colspan="6" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Insight Panel -->
      <div class="card">
        <h3>üß† Insight Cepat (Untuk Manager)</h3>
        <div class="space-y-3 text-sm text-slate-700" id="insightBox">
          <div class="text-slate-400">Menunggu data‚Ä¶</div>
        </div>
      </div>

      <!-- Bottom Sellers -->
      <div class="card lg:col-span-2">
        <h3>üê¢ Bottom Sellers (Paling Tidak Laku)</h3>
        <div id="bottom-summary" class="mb-3 text-xs font-bold text-red-700 bg-red-50 px-3 py-2 rounded-lg">Loading Summary...</div>
        <div class="chart-box"><canvas id="bottomChart"></canvas></div>
        <div class="mt-4 overflow-x-auto" style="max-height: 360px; overflow-y:auto; border-radius: 14px;">
          <table class="table">
            <thead>
              <tr>
                <th style="width:54px;">#</th>
                <th>Menu</th>
                <th style="width:140px;">Kategori</th>
                <th style="width:90px;">Qty</th>
                <th style="width:140px;">Terakhir Laku</th>
                <th style="width:130px;">Saran</th>
              </tr>
            </thead>
            <tbody id="bottomTbody">
              <tr><td colspan="6" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Shift + Payment Split -->
      <div class="card">
        <h3>üí≥ Payment Split & Shift</h3>
        <div class="grid grid-cols-1 gap-3">
          <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-slate-900">Payment Split</div>
              <span class="pill bg-indigo-100 text-indigo-700" id="split-pill">0% QRIS</span>
            </div>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-slate-600 font-semibold">QRIS / Transfer</span><span class="font-extrabold" id="split-q">Rp 0</span></div>
              <div class="flex justify-between"><span class="text-slate-600 font-semibold">Cash</span><span class="font-extrabold" id="split-c">Rp 0</span></div>
              <div class="border-t pt-2 flex justify-between"><span class="text-slate-600 font-semibold">Total</span><span class="font-extrabold" id="split-t">Rp 0</span></div>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200 bg-white">
            <div class="font-extrabold text-slate-900 mb-2">Ringkasan Shift</div>
            <div class="text-xs text-slate-500 mb-3">00‚Äì08 (Pagi) ‚Ä¢ 08‚Äì16 (Siang) ‚Ä¢ 16‚Äì24 (Malam)</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Pagi</span><span class="font-extrabold" id="shift-pagi">Rp 0</span></div>
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Siang</span><span class="font-extrabold" id="shift-siang">Rp 0</span></div>
              <div class="flex justify-between"><span class="font-semibold text-slate-600">Malam</span><span class="font-extrabold" id="shift-malam">Rp 0</span></div>
              <div class="border-t pt-2 flex justify-between"><span class="font-semibold text-slate-600">Total</span><span class="font-extrabold" id="shift-total">Rp 0</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Raw Transactions -->
    <div class="card">
      <h3>üßæ Transaksi (Ringkas)</h3>
      <div class="text-xs text-slate-500 mb-3">Menampilkan transaksi yang mengandung item sesuai filter.</div>
      <div class="overflow-x-auto" style="max-height: 320px; overflow-y:auto; border-radius: 14px;">
        <table class="table">
          <thead>
            <tr>
              <th style="width:140px;">Waktu</th>
              <th style="width:90px;">Shift</th>
              <th>Meja / Pelanggan</th>
              <th style="width:120px;">Metode</th>
              <th style="width:140px;" class="text-right">Total Order</th>
            </tr>
          </thead>
          <tbody id="txnTbody">
            <tr><td colspan="5" class="text-center py-8 text-slate-400">Menunggu data‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="toast" class="toast">Error</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyB0nHqdAw_dV9pHcQ_cSnWtNsn4CwwwUNc",
      authDomain: "payboss-cafe-system.firebaseapp.com",
      projectId: "payboss-cafe-system",
      storageBucket: "payboss-cafe-system.firebasestorage.app",
      messagingSenderId: "570523503793",
      appId: "1:570523503793:web:0a7ba7ce751eb95a3f6690",
      measurementId: "G-H1NJ369HE9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== State =====
    let allOrders = [];
    let filteredOrders = [];

    let currentFilter = 'week'; // UBAH DEFAULT KE 'week' (7 Hari) AGAR DATA LANGSUNG MUNCUL
    let currentCategory = 'All'; 
    let customRange = { start: null, end: null };

    let topChart = null;
    let bottomChart = null;
    let matrixChart = null;

    // ===== Helpers =====
    const DAY = 86400000;

    function showError(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4500);
    }

    function fmtRp(n) { return 'Rp ' + (Math.round(n || 0)).toLocaleString('id-ID'); }
    function pct(x) { return (isFinite(x) ? (x * 100).toFixed(1) : '0.0') + '%'; }

    function getBizDate(ts) {
      const d = new Date(ts);
      d.setHours(0,0,0,0);
      return d.getTime();
    }

    function normalizePayment(pm) {
      const s = String(pm || '').toLowerCase();
      if (s.includes('qris') || s.includes('transfer') || s.includes('ovo') || s.includes('gopay') || s.includes('dana')) return 'qris';
      return 'cash';
    }

    function getShiftLabel(ts) {
      const h = new Date(ts).getHours();
      if (h >= 0 && h < 8) return 'Pagi';
      if (h >= 8 && h < 16) return 'Siang';
      return 'Malam';
    }

    // ===== HEURISTIK KATEGORI SIMPLE (3 KATEGORI UTAMA) =====
    const CATEGORY_RULES = [
      // 1. MINUMAN (Gabungan: Coffee, Kopi Susu, Non Coffee, Mocktail, Tea)
      { 
        key: 'Minuman', 
        test: /(americano|latte|coffee|kopi|cappucino|magic|split|vietnam|banana|brown sugar|butterscotch|caramel|almond|hazelnut|espresso|vanilla|chocolate|cookies|matcha|red velvet|taro|mocktail|dark moon|flora|honey|kiwi|lembayung|midnight|ocean|peach|summer|tropical|lemon tea|tea)/i 
      },
      
      // 2. MAKANAN (Gabungan: Food, Snacks, Pastry, Dessert)
      { 
        key: 'Makanan', 
        test: /(kwetiau|mie|nasi|steak|spaghetti|bebek|bapao|burger|bola|chicken|cireng|empek|jamur|kentang|kulit|mix|pisang|roti|singkong|sotong|tahu|tempe|tofu|corn|gyoza|sosis|cheesecake|tiramisu|brownies|misu|mousse|donat|tom & jerry|sago|smoothie)/i 
      },

      // 3. LAIN LAIN (Item spesifik non-menu utama)
      { 
        key: 'Lain lain', 
        test: /(telur|sauce|cleo|rokok|tissue|mineral|nasi putih$)/i 
      }
    ];

    function inferCategory(item) {
      const name = String(item?.name || '');
      
      const lainRule = CATEGORY_RULES.find(r => r.key === 'Lain lain');
      if (lainRule.test.test(name)) return 'Lain lain';

      for (const r of CATEGORY_RULES) {
         if (r.key !== 'Lain lain' && r.test.test(name)) return r.key;
      }
      return 'Lain lain';
    }

    function safeItems(order) {
      const items = Array.isArray(order?.items) ? order.items : [];
      return items.map(i => ({
        name: String(i?.name || '-').trim(),
        qty: Number(i?.qty || 0) || 0,
        price: Number(i?.price || i?.unitPrice || 0) || 0,
        category: i?.category || i?.type || ''
      })).filter(i => i.name && i.qty > 0);
    }

    function computeMetrics(orders) {
      const totalOrders = orders.length; 
      let filteredOrderCount = 0;
      let totalRevenue = 0;
      let totalQty = 0;
      let payQ = 0, payC = 0;
      const shift = { Pagi: 0, Siang: 0, Malam: 0 };
      const itemAgg = new Map();

      orders.forEach(o => {
        const total = Number(o?.total || 0) || 0;
        const ts = Number(o?.timestamp || 0) || 0;
        if (!ts) return;

        const allItems = safeItems(o);
        const relevantItems = allItems.filter(i => {
            const cat = inferCategory(i);
            if (currentCategory === 'All') return true;
            return cat === currentCategory;
        });

        if (relevantItems.length === 0) return;

        filteredOrderCount++;
        let relevantRevenue = 0;
        const sumPrice = relevantItems.reduce((acc, i) => acc + (i.price * i.qty), 0);
        
        if (sumPrice > 0) {
            relevantRevenue = sumPrice;
        } else {
            const allItemsQty = allItems.reduce((acc, i) => acc + i.qty, 0);
            const relevantQty = relevantItems.reduce((acc, i) => acc + i.qty, 0);
            if (allItemsQty > 0) relevantRevenue = total * (relevantQty / allItemsQty);
        }

        totalRevenue += relevantRevenue;
        
        const p = normalizePayment(o?.paymentMethod);
        if (p === 'qris') payQ += relevantRevenue; else payC += relevantRevenue;
        shift[getShiftLabel(ts)] += relevantRevenue;

        const uniqueInOrder = new Map(); 
        relevantItems.forEach(it => {
          let itemRev = 0;
          if (it.price > 0) itemRev = it.qty * it.price;
          else {
               const allItemsQty = allItems.reduce((acc, i) => acc + i.qty, 0);
               if (allItemsQty > 0) itemRev = total * (it.qty / allItemsQty);
          }

          totalQty += it.qty;
          const cat = inferCategory(it);
          if (!itemAgg.has(it.name)) itemAgg.set(it.name, { name: it.name, qty: 0, revenue: 0, txCount: 0, category: cat, lastSold: 0 });
          const row = itemAgg.get(it.name);
          row.qty += it.qty;
          row.revenue += itemRev;
          if (ts > row.lastSold) row.lastSold = ts;
          if (row.category === 'Lain lain' && cat !== 'Lain lain') row.category = cat;
          if (!uniqueInOrder.has(it.name)) uniqueInOrder.set(it.name, true);
        });

        uniqueInOrder.forEach((_, name) => {
            if (itemAgg.has(name)) itemAgg.get(name).txCount += 1;
        });
      });

      const items = Array.from(itemAgg.values()).map(r => ({
        ...r,
        attachRate: filteredOrderCount ? (r.txCount / filteredOrderCount) : 0,
        revShare: totalRevenue ? (r.revenue / totalRevenue) : 0,
        avgPrice: r.qty ? (r.revenue / r.qty) : 0,
      }));

      return {
        totalOrders: filteredOrderCount, totalRevenue, totalQty,
        aov: filteredOrderCount ? (totalRevenue / filteredOrderCount) : 0,
        itemsPerOrder: filteredOrderCount ? (totalQty / filteredOrderCount) : 0,
        payQ, payC, shift, items
      };
    }

    // ===== Growth Logic =====
    function getPreviousRange(currentP, startC, endC) {
      if (currentP === 'today') {
        const prevStart = startC - (7 * DAY);
        const prevEnd = endC - (7 * DAY);
        return { start: prevStart, end: prevEnd, label: 'vs Minggu Lalu' };
      }
      if (currentP === 'week') {
        const prevStart = startC - (7 * DAY);
        const prevEnd = startC - DAY; 
        return { start: prevStart, end: prevEnd, label: 'vs 7 Hari Lalu' };
      }
      if (currentP === 'month') {
        const prevStart = startC - (30 * DAY);
        const prevEnd = startC - DAY;
        return { start: prevStart, end: prevEnd, label: 'vs 30 Hari Lalu' };
      }
      const duration = endC - startC;
      const prevEnd = startC - DAY;
      const prevStart = prevEnd - duration;
      return { start: prevStart, end: prevEnd, label: 'vs Periode Lalu' };
    }

    function renderGrowth(currM, startC, endC) {
      const { start, end, label } = getPreviousRange(currentFilter, startC, endC);
      const prevOrders = allOrders.filter(o => {
        if (!o?.timestamp) return false;
        const biz = getBizDate(o.timestamp);
        return biz >= start && biz <= end;
      });
      const prevM = computeMetrics(prevOrders);

      // Revenue Growth
      const revEl = document.getElementById('rev-growth');
      if (prevM.totalRevenue === 0) {
         revEl.innerHTML = currM.totalRevenue > 0 ? `‚ñ≤ 100% ${label}` : `- ${label}`;
         revEl.className = `growth-badge ${currM.totalRevenue > 0 ? 'growth-up' : 'growth-neutral'}`;
      } else {
         const diff = currM.totalRevenue - prevM.totalRevenue;
         const pct = (diff / prevM.totalRevenue) * 100;
         const isUp = diff >= 0;
         revEl.innerHTML = `${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct).toFixed(0)}% ${label}`;
         revEl.className = `growth-badge ${isUp ? 'growth-up' : 'growth-down'}`;
      }

      // Order Growth
      const ordEl = document.getElementById('ord-growth');
      if (prevM.totalOrders === 0) {
         ordEl.innerHTML = currM.totalOrders > 0 ? `‚ñ≤ 100% ${label}` : `- ${label}`;
         ordEl.className = `growth-badge ${currM.totalOrders > 0 ? 'growth-up' : 'growth-neutral'}`;
      } else {
         const diff = currM.totalOrders - prevM.totalOrders;
         const pct = (diff / prevM.totalOrders) * 100;
         const isUp = diff >= 0;
         ordEl.innerHTML = `${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(pct).toFixed(0)}% ${label}`;
         ordEl.className = `growth-badge ${isUp ? 'growth-up' : 'growth-down'}`;
      }
    }

    function filterOrders(period) {
      const now = new Date();
      const today = getBizDate(now.getTime());

      let startBiz = null;
      let endBiz = null;

      if (period === 'today') {
        startBiz = today;
        endBiz = today;
      } else if (period === 'week') {
        startBiz = today - 6 * DAY;
        endBiz = today;
      } else if (period === 'month') {
        startBiz = today - 29 * DAY;
        endBiz = today;
      } else if (period === 'custom') {
        startBiz = customRange.start ?? today;
        endBiz = customRange.end ?? today;
      }

      filteredOrders = allOrders.filter(o => {
        if (!o?.timestamp) return false;
        const biz = getBizDate(o.timestamp);
        return biz >= startBiz && biz <= endBiz;
      });

      const label = document.getElementById('range-label');
      const fmtDate = (ms) => new Date(ms).toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
      if (period === 'today') label.textContent = 'Range: Hari ini';
      else label.textContent = `Range: ${fmtDate(startBiz)} ‚Äî ${fmtDate(endBiz)}`;

      renderAll();
      const m = computeMetrics(filteredOrders);
      renderGrowth(m, startBiz, endBiz);
    }

    // ===== Rendering KPIs =====
    function renderKPIs(m) {
      document.getElementById('kpi-revenue').textContent = fmtRp(m.totalRevenue);
      document.getElementById('kpi-orders').textContent = (m.totalOrders || 0).toLocaleString('id-ID');
      document.getElementById('kpi-items').textContent = (m.totalQty || 0).toLocaleString('id-ID');
      document.getElementById('kpi-aov').textContent = fmtRp(m.aov);
      document.getElementById('kpi-ipo').textContent = (m.itemsPerOrder || 0).toFixed(2);

      const qPct = m.totalRevenue ? (m.payQ / m.totalRevenue) : 0;
      const cPct = m.totalRevenue ? (m.payC / m.totalRevenue) : 0;
      document.getElementById('kpi-revenue-sub').textContent = `${pct(qPct)} QRIS ‚Ä¢ ${pct(cPct)} Cash`;

      document.getElementById('split-q').textContent = fmtRp(m.payQ);
      document.getElementById('split-c').textContent = fmtRp(m.payC);
      document.getElementById('split-t').textContent = fmtRp(m.totalRevenue);
      document.getElementById('split-pill').textContent = `${pct(qPct)} QRIS`;

      document.getElementById('shift-pagi').textContent = fmtRp(m.shift.Pagi);
      document.getElementById('shift-siang').textContent = fmtRp(m.shift.Siang);
      document.getElementById('shift-malam').textContent = fmtRp(m.shift.Malam);
      document.getElementById('shift-total').textContent = fmtRp(m.totalRevenue);
    }

    function buildSuggestion(item, topBest) {
      const name = item.name;
      const cat = item.category;
      const isDrink = cat === 'Minuman';
      const best = topBest?.name ? topBest.name : 'menu terlaris';
      if (item.qty <= 1) return `Bundling dgn ${best}`;
      if (item.attachRate < 0.1) return 'Cek kualitas rasa';
      if (isDrink) return 'Promo jam sepi';
      return 'Potensi Hapus';
    }

    function formatTimeAgo(ts) {
        if (!ts) return 'Tidak diketahui';
        const diff = Date.now() - ts;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        if (days === 0) return 'Hari ini';
        if (days === 1) return 'Kemarin';
        return `${days} hari lalu`;
    }

    function renderCharts(top, bottom) {
      const topCtx = document.getElementById('topChart');
      const bottomCtx = document.getElementById('bottomChart');

      if (topChart) topChart.destroy();
      if (bottomChart) bottomChart.destroy();

      topChart = new Chart(topCtx, {
        type: 'bar',
        data: {
          labels: top.map(x => x.name),
          datasets: [{ label: 'Qty Terjual', data: top.map(x => x.qty), backgroundColor: '#4f46e5', borderRadius: 8 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#e2e8f0' } },
            x: { grid: { display: false }, ticks: { autoSkip: false, maxRotation: 90, minRotation: 90 } }
          }
        }
      });

      bottomChart = new Chart(bottomCtx, {
        type: 'bar',
        data: {
          labels: bottom.map(x => x.name),
          datasets: [{ label: 'Qty Terjual', data: bottom.map(x => x.qty), backgroundColor: '#ef4444', borderRadius: 8 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#e2e8f0' } },
            x: { grid: { display: false }, ticks: { autoSkip: false, maxRotation: 90, minRotation: 90 } }
          }
        }
      });
    }

    function renderMatrix(items) {
       const ctx = document.getElementById('matrixChart');
       const insightBox = document.getElementById('matrix-insight');
       const tableBody = document.getElementById('matrixTableBody');
       
       if (!ctx || !insightBox || !tableBody) return;
       if (matrixChart) matrixChart.destroy();

       const activeItems = items.filter(x => x.qty > 0);
       
       if(activeItems.length === 0) {
           insightBox.innerHTML = '<div class="text-center text-slate-400 text-sm">Data belum cukup untuk analisis.</div>';
           tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-400">Belum ada data...</td></tr>';
           return; 
       }

       const totalQty = activeItems.reduce((a,b) => a + b.qty, 0);
       const totalRev = activeItems.reduce((a,b) => a + b.revenue, 0);
       const count = activeItems.length;
       const avgQty = totalQty / count;
       const avgRev = totalRev / count;

       let counts = { stars: 0, plowhorses: 0, puzzles: 0, dogs: 0 };

       const dataset = activeItems.map(item => {
          let color = '#94a3b8'; 
          let cat = 'Unknown';
          let badgeClass = '';
          
          if (item.qty >= avgQty && item.revenue >= avgRev) {
             color = '#22c55e'; cat = 'Stars'; counts.stars++; badgeClass = 'mx-stars';
          } else if (item.qty >= avgQty && item.revenue < avgRev) {
             color = '#eab308'; cat = 'Plowhorses'; counts.plowhorses++; badgeClass = 'mx-plow';
          } else if (item.qty < avgQty && item.revenue >= avgRev) {
             color = '#60a5fa'; cat = 'Puzzles'; counts.puzzles++; badgeClass = 'mx-puzzle';
          } else {
             color = '#ef4444'; cat = 'Dogs'; counts.dogs++; badgeClass = 'mx-dogs';
          }

          return { x: item.qty, y: item.revenue, name: item.name, category: item.category, cat: cat, color: color, badgeClass: badgeClass };
       });

       let dominant = 'Dogs';
       let maxVal = counts.dogs;
       if (counts.stars > maxVal) { dominant = 'Stars'; maxVal = counts.stars; }
       if (counts.plowhorses > maxVal) { dominant = 'Plowhorses'; maxVal = counts.plowhorses; }
       if (counts.puzzles > maxVal) { dominant = 'Puzzles'; maxVal = counts.puzzles; }

       let advice = '';
       if (dominant === 'Stars') advice = 'Strategi aman. Pertahankan kualitas & stok.';
       if (dominant === 'Plowhorses') advice = 'Populer tapi untung tipis. Coba naikkan harga atau efisiensi porsi.';
       if (dominant === 'Puzzles') advice = 'Untung besar tapi sepi. Fokus ke marketing & foto produk menarik.';
       if (dominant === 'Dogs') advice = 'Banyak menu beban. Evaluasi rasa atau hapus item yang > 30 hari tidak laku.';

       insightBox.innerHTML = `
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-center">
             <div class="bg-green-50 p-2 rounded-lg"><div class="font-bold text-lg text-green-700">${counts.stars}</div><div class="text-xs text-green-600">Stars</div></div>
             <div class="bg-yellow-50 p-2 rounded-lg"><div class="font-bold text-lg text-yellow-700">${counts.plowhorses}</div><div class="text-xs text-yellow-600">Plowhorses</div></div>
             <div class="bg-blue-50 p-2 rounded-lg"><div class="font-bold text-lg text-blue-700">${counts.puzzles}</div><div class="text-xs text-blue-600">Puzzles</div></div>
             <div class="bg-red-50 p-2 rounded-lg"><div class="font-bold text-lg text-red-700">${counts.dogs}</div><div class="text-xs text-red-600">Dogs</div></div>
          </div>
          <div class="border-t border-slate-100 pt-3">
             <div class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Kesimpulan & Rekomendasi</div>
             <div class="text-sm text-slate-800 font-medium">Dominasi: <span class="font-bold text-indigo-600">${dominant}</span>.</div>
             <div class="text-sm text-slate-600 mt-1">${advice}</div>
          </div>
       `;

       const order = { 'Stars': 1, 'Plowhorses': 2, 'Puzzles': 3, 'Dogs': 4 };
       const sortedData = [...dataset].sort((a,b) => (order[a.cat] - order[b.cat]) || (b.y - a.y));

       tableBody.innerHTML = sortedData.map(d => `
          <tr>
             <td class="font-bold text-slate-700">${escapeHtml(d.name)}</td>
             <td class="text-xs text-slate-500">${escapeHtml(d.category)}</td>
             <td class="font-mono">${d.x}</td>
             <td class="font-mono">${fmtRp(d.y)}</td>
             <td><span class="mx-badge ${d.badgeClass}">${d.cat}</span></td>
          </tr>
       `).join('');

       matrixChart = new Chart(ctx, {
          type: 'scatter',
          data: { datasets: [{ label: 'Menu Matrix', data: dataset, backgroundColor: dataset.map(d => d.color), pointRadius: 6, pointHoverRadius: 8 }] },
          options: {
             responsive: true, maintainAspectRatio: false,
             plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw.name}: ${ctx.raw.x} Qty, ${fmtRp(ctx.raw.y)}` } } },
             scales: {
                x: { title: { display: true, text: 'Popularitas (Qty Terjual)' }, grid: { color: (ctx) => ctx.tick.value === 0 ? '#000' : '#e2e8f0' } },
                y: { title: { display: true, text: 'Profitabilitas (Revenue)' }, grid: { color: '#e2e8f0' } }
             }
          }
       });
    }

    function renderInsight(m, top, bottom) {
      const box = document.getElementById('insightBox');
      if (!m.totalOrders) { box.innerHTML = '<div class="text-slate-400">Belum ada transaksi.</div>'; return; }
      const best = top[0]; const worst = bottom[0];
      const top5RevShare = top.slice(0,5).reduce((a,x)=>a + x.revShare, 0);
      const qPct = m.totalRevenue ? (m.payQ / m.totalRevenue) : 0;
      const peakShift = Object.entries(m.shift).sort((a,b)=>b[1]-a[1])[0];

      box.innerHTML = `
        <div class="p-3 rounded-xl bg-indigo-50 border border-indigo-100">
          <div class="font-extrabold text-indigo-900">Fokus Terlaris (${currentCategory})</div>
          <div class="mt-1">Menu #1: <span class="font-extrabold">${escapeHtml(best?.name || '-')}</span> ‚Ä¢ Qty <span class="font-extrabold">${best?.qty || 0}</span> ‚Ä¢ Rev Share <span class="font-extrabold">${pct(best?.revShare || 0)}</span></div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
          <div class="font-extrabold text-slate-900">Operasional</div>
          <div class="mt-1">Metode bayar: <span class="font-extrabold">${pct(qPct)}</span> QRIS. Shift ramai: <span class="font-extrabold">${peakShift?.[0] || '-'}</span>.</div>
        </div>
      `;
    }

    function renderTransactions(orders) {
      const tbody = document.getElementById('txnTbody');
      const activeTxns = orders.filter(o => {
         const allItems = safeItems(o);
         const relevant = allItems.filter(i => {
             const cat = inferCategory(i);
             if (currentCategory === 'All') return true;
             return cat === currentCategory;
         });
         return relevant.length > 0;
      });

      if (!activeTxns.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-400">Belum ada transaksi...</td></tr>'; return; }
      
      const sorted = [...activeTxns].sort((a,b) => b.timestamp - a.timestamp).slice(0, 120);
      tbody.innerHTML = sorted.map(o => {
        const d = new Date(o.timestamp);
        const timeStr = d.toLocaleString('id-ID', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
        const shift = getShiftLabel(o.timestamp);
        const shiftCls = shift==='Pagi' ? 'bg-amber-100 text-amber-800' : shift==='Siang' ? 'bg-emerald-100 text-emerald-700' : 'bg-violet-100 text-violet-700';
        const pay = normalizePayment(o.paymentMethod);
        const payCls = pay==='qris' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-700';
        return `
          <tr>
            <td class="font-mono text-xs text-slate-500">${timeStr}</td>
            <td><span class="pill ${shiftCls}">${shift}</span></td>
            <td class="font-semibold text-slate-800">${escapeHtml(o.table || '-')}${o.customer ? ' / ' + escapeHtml(o.customer) : ''}</td>
            <td><span class="pill ${payCls}">${(o.paymentMethod || (pay==='qris'?'QRIS':'CASH')).toString()}</span></td>
            <td class="text-right font-extrabold">${fmtRp(o.total)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderTables() {
      if (!filteredOrders) return;
      const m = computeMetrics(filteredOrders);
      const search = String(document.getElementById('search-item').value || '').trim().toLowerCase();
      const itemsAll = m.items.filter(x => x.name && (search ? x.name.toLowerCase().includes(search) : true)).filter(x => x.qty > 0);

      const top = [...itemsAll].sort((a,b)=>b.qty - a.qty || b.revenue - a.revenue).slice(0, 12);
      const bottom = [...itemsAll].sort((a,b)=>a.qty - b.qty || a.revenue - b.revenue).slice(0, 12);

      const topT = document.getElementById('topTbody');
      const bottomT = document.getElementById('bottomTbody');

      const top5Share = top.slice(0,5).reduce((acc, curr) => acc + curr.revShare, 0) * 100;
      document.getElementById('top-summary').innerText = `üî• Top 5 Menu Menyumbang ${top5Share.toFixed(1)}% dari Total Omset`;
      const bottom5Share = bottom.slice(0,5).reduce((acc, curr) => acc + curr.revShare, 0) * 100;
      document.getElementById('bottom-summary').innerText = `‚ö†Ô∏è 5 Menu Terbawah Hanya Menyumbang ${bottom5Share.toFixed(2)}% dari Total Omset`;

      const renderRows = (arr, isTop) => arr.length ? arr.map((x, i) => `
        <tr>
          <td class="font-black text-slate-500">${i + 1}</td>
          <td class="font-extrabold">${escapeHtml(x.name)}</td>
          <td><span class="pill ${x.category === 'Makanan' ? 'bg-amber-100 text-amber-800' : 'bg-indigo-100 text-indigo-700'}">${escapeHtml(x.category)}</span></td>
          <td class="font-extrabold">${x.qty}</td>
          <td class="font-extrabold">${isTop ? fmtRp(x.revenue) : formatTimeAgo(x.lastSold)}</td>
          <td><span class="pill ${isTop ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">${isTop ? pct(x.revShare) : escapeHtml(buildSuggestion(x, top[0]))}</span></td>
        </tr>`).join('') : '<tr><td colspan="6" class="text-center py-8 text-slate-400">Belum ada data.</td></tr>';

      topT.innerHTML = renderRows(top, true);
      bottomT.innerHTML = renderRows(bottom, false);

      const itemsNoSearch = m.items.filter(x => x.qty > 0);
      const topNoSearch = [...itemsNoSearch].sort((a,b)=>b.qty - a.qty).slice(0, 10);
      const bottomNoSearch = [...itemsNoSearch].sort((a,b)=>a.qty - b.qty).slice(0, 10);

      renderCharts(topNoSearch, bottomNoSearch);
      renderMatrix(itemsNoSearch);
      renderInsight(m, topNoSearch, bottomNoSearch);
      window.__last_metrics = { m, top: topNoSearch, bottom: bottomNoSearch };
    }

    window.downloadCSV = () => { /* ... existing export logic ... */ };
    window.setFilter = (filter) => {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-100','text-indigo-700'); btn.classList.add('text-slate-600');
      });
      document.getElementById(`btn-${filter}`).classList.replace('text-slate-600', 'text-indigo-700');
      document.getElementById(`btn-${filter}`).classList.add('bg-indigo-100');
      filterOrders(filter);
    };

    window.setCategory = (cat) => { currentCategory = cat; renderAll(); filterOrders(currentFilter); };
    window.applyCustomRange = () => { /* ... existing custom range logic ... */ };
    window.handleLogin = async (e) => { /* ... existing login logic ... */ };
    window.doLogout = () => signOut(auth);

    function escapeHtml(str) { return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function renderAll() {
      const m = computeMetrics(filteredOrders);
      renderKPIs(m);
      renderTables();
      renderTransactions(filteredOrders);
    }

    // ===== NEW: MANUAL DATA FETCHING (Hemat Kuota) =====
    window.fetchData = async () => {
       const statusEl = document.getElementById('data-status-label');
       const btn = document.getElementById('btn-refresh');
       
       statusEl.textContent = 'Sedang mengambil data...';
       btn.disabled = true;
       btn.innerHTML = '‚è≥ Loading...';

       try {
           // REVISI: Hapus 'orderBy' untuk menghindari error index/missing field.
           // Kita ambil data secara raw (limit 2000), lalu sort di client-side (Javascript).
           // Ini jauh lebih aman untuk memastikan data muncul dulu.
           const q = query(
              collection(db, 'completedOrders'), 
              limit(2000) 
           );
           
           const snap = await getDocs(q);
           
           allOrders = snap.docs.map(d => {
              const data = d.data();
              // Normalisasi timestamp
              const ts = data.createdAt?.seconds ? data.createdAt.seconds * 1000 : (data.timestamp || Date.now());
              return { ...data, timestamp: ts };
           })
           .filter(o => o.timestamp && (Number(o.total || 0) >= 0))
           // SORTING MANUAL DI SINI (Client Side)
           .sort((a, b) => b.timestamp - a.timestamp);
           
           // Init Dates
           const now = new Date();
           const yyyy = now.getFullYear();
           const mm = String(now.getMonth()+1).padStart(2,'0');
           const dd = String(now.getDate()).padStart(2,'0');
           document.getElementById('date-start').value = `${yyyy}-${mm}-${dd}`;
           document.getElementById('date-end').value = `${yyyy}-${mm}-${dd}`;

           // Update tampilan UI Filter agar sesuai default 'week'
           document.querySelectorAll('.filter-btn').forEach(b => {
               b.classList.remove('bg-indigo-100','text-indigo-700'); 
               b.classList.add('text-slate-600');
           });
           const btnWeek = document.getElementById('btn-week');
           if(btnWeek) {
               btnWeek.classList.remove('text-slate-600');
               btnWeek.classList.add('bg-indigo-100','text-indigo-700');
           }

           filterOrders(currentFilter);
           
           statusEl.textContent = `Data terupdate: ${new Date().toLocaleTimeString()} (${allOrders.length} data)`;
           statusEl.className = 'text-green-600 font-bold';
       } catch (err) {
           console.error(err);
           showError('Gagal mengambil data: ' + err.message);
           statusEl.textContent = 'Gagal update data.';
           statusEl.className = 'text-red-600';
       } finally {
           btn.disabled = false;
           btn.innerHTML = 'üîÑ Refresh Data';
       }
    };

    // ===== Boot =====
    onAuthStateChanged(auth, (user) => {
      const overlay = document.getElementById('auth-overlay');
      const dashboard = document.getElementById('dashboard-ui');

      if (user) {
        overlay.style.display = 'none';
        dashboard.style.display = 'block';
        
        // PANGGIL MANUAL SATU KALI SAJA SAAT LOGIN
        fetchData(); 

      } else {
        overlay.style.display = 'flex';
        dashboard.style.display = 'none';
      }
    });

  </script>
</body>
</html>
